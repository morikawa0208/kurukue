<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>White Dungeon - Professional Build System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        
        html, body {
            margin: 0;
            padding: 0;
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            align-items: center;
        }

        .app-shell {
            width: clamp(0px, 100%, 460px);
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        .page { display: none; height: 100%; min-height: 0; flex-direction: column; overflow-y: auto; }
        .page.active { display: flex; }

        /* Status Bars */
        .bar-container { position: relative; background-color: #e2e8f0; border-radius: 6px; overflow: hidden; height: 20px; border: 1px solid #cbd5e1; width: 100%; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        .hp-fill { background-color: #ef4444; }
        .mp-fill { background-color: #3b82f6; }
        .exp-fill { background-color: #fbbf24; }
        .bar-text { position: absolute; inset: 0; display: flex; items-center; justify-content: center; font-size: 10px; font-weight: 800; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.5); pointer-events: none; }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-40px); }
        }
        .damage-text {
            position: absolute;
            font-weight: 900;
            font-size: 1.5rem;
            animation: floatUp 0.8s forwards;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 0 #fff;
        }

        .mini-log {
            font-size: 10px;
            line-height: 1.2;
            mask-image: linear-gradient(to top, black 70%, transparent 100%);
        }

        .rarity-normal { color: #334155; font-weight: bold; }
        .rarity-magic { color: #3b82f6; font-weight: bold; }
        .rarity-rare { color: #facc15; font-weight: bold; }
        .rarity-epic { color: #a855f7; font-weight: bold; }
        .rarity-legendary { color: #a16207; font-weight: bold; text-shadow: 0 0 8px rgba(161, 98, 7, 0.35); }

        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        nav button.active { color: #0f172a; border-top: 3px solid #0f172a; background-color: #fff; }
        .job-tab.active { background-color: #0f172a; color: white; }
        .type-tab.active { border-bottom: 3px solid #0f172a; color: #0f172a; font-weight: bold; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col">
    <div class="app-shell">

    <!-- TOP BAR -->
    <header class="h-12 border-b flex items-center justify-between px-4 shrink-0 bg-white z-50 shadow-sm">
        <div class="font-bold flex items-center gap-2">
            <span class="text-slate-400 text-xs">FLOOR</span>
            <span id="floor-display" class="text-xl font-black">1</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-bold">SP: <span id="header-sp">0</span></span>
            <span class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded-full font-bold"><i class="fas fa-coins"></i> <span id="header-gold">0</span>G</span>
            <div class="bg-slate-800 text-white text-[10px] px-2 py-1 rounded font-bold">Lv.<span id="header-lvl">1</span></div>
        </div>
    </header>

    <!-- CONTENT PAGES -->
    <main class="flex-1 overflow-hidden relative min-h-0">
        
        <!-- BATTLE PAGE -->
        <section id="page-battle" class="page active p-4">
            <div class="flex-1 flex flex-col items-center justify-center relative min-h-[200px]">
                <div id="enemy-container" class="text-center transition-all duration-300">
                    <div id="enemy-visual" class="text-8xl mb-4 text-slate-700"><i class="fas fa-ghost"></i></div>
                <div id="enemy-name" class="font-bold text-lg mb-1">スライム</div>
                <div class="w-48 bar-container mx-auto mb-1 border-0 bg-slate-200">
                    <div id="enemy-hp-bar" class="bar-fill hp-fill"></div>
                    <div class="bar-text">HP: <span id="enemy-hp-text">30/30</span></div>
                </div>
                <div id="enemy-status-effects" class="flex flex-wrap justify-center gap-1 mt-1 text-[10px]"></div>
            </div>
                <div id="damage-layer" class="absolute inset-0 pointer-events-none"></div>
                <div class="absolute right-0 bottom-4 w-1/2 mini-log pointer-events-none text-right pr-2 text-slate-500 italic space-y-1">
                    <div id="mini-log-2"></div>
                    <div id="mini-log-1"></div>
                    <div id="mini-log-0" class="text-slate-800 font-bold"></div>
                </div>
            </div>

            <!-- Player Status Section -->
            <div class="bg-white border rounded-2xl p-4 shadow-sm space-y-3 mb-2">
                <div class="space-y-1.5">
                    <div class="bar-container">
                        <div id="player-hp-bar" class="bar-fill hp-fill"></div>
                        <div class="bar-text">HP: <span id="player-hp-text">100/100</span></div>
                    </div>
                    <div class="bar-container">
                        <div id="player-mp-bar" class="bar-fill mp-fill"></div>
                        <div class="bar-text">MP: <span id="player-mp-text">30/30</span></div>
                    </div>
                    <div class="bar-container">
                        <div id="player-exp-bar-battle" class="bar-fill exp-fill"></div>
                        <div class="bar-text">EXP: <span id="player-exp-text-battle">0/100</span></div>
                    </div>
                    <div>
                        <div id="player-status-effects" class="flex flex-wrap gap-1 mt-1 text-[10px] h-[21.5px]"></div>
                    </div>
                </div>

                <div class="space-y-2">
                    <div id="battle-skill-slots"></div>
                </div>
                <button id="action-btn" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg flex items-center justify-center gap-2">
                    <i class="fas fa-sword"></i> <span>攻撃</span>
                </button>
            </div>
            
            <div id="death-overlay" class="absolute inset-0 bg-red-900/40 backdrop-blur-[2px] hidden items-center justify-center z-50">
                <div class="bg-white p-8 rounded-3xl shadow-2xl text-center border-2 border-red-500 mx-4">
                    <div class="text-6xl mb-4">💀</div>
                    <h2 class="text-2xl font-black text-red-600 mb-2">YOU DIED</h2>
                    <p class="text-sm text-slate-500 mb-2">ペナルティが発生しました：</p>
                    <div class="text-xs text-red-600 font-bold mb-6 bg-red-50 p-3 rounded-xl">
                        階層: -20<br>
                        経験値ロスト: <span id="lost-exp-val">0</span>
                    </div>
                    <button onclick="revive()" class="w-full bg-red-600 text-white font-bold px-8 py-4 rounded-xl shadow-lg active:scale-95">街に戻る</button>
                </div>
            </div>
        </section>

        <!-- STATUS PAGE -->
        <section id="page-status" class="page p-4 bg-slate-50">
            <h2 class="text-xl font-black mb-4 flex items-center gap-2 px-2"><i class="fas fa-user-circle"></i> ステータス</h2>
            
            <!-- Summary Card -->
            <div class="bg-white rounded-3xl p-6 shadow-sm mb-4">
                <div class="flex items-center justify-between border-b pb-4 mb-4">
                    <div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Level</div>
                        <div class="text-4xl font-black" id="status-lvl">1</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Experience</div>
                        <div class="text-sm font-bold"><span id="status-exp">0</span> / <span id="status-next">100</span></div>
                        <div class="w-32 bar-container h-2 mt-1 border-0 bg-slate-100"><div id="status-exp-bar" class="bar-fill exp-fill"></div></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-y-6 gap-x-4">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">STR (物理攻撃)</span>
                        <span class="text-2xl font-black text-slate-700" id="status-atk">10</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">VIT (物理防御)</span>
                        <span class="text-2xl font-black text-slate-700" id="status-def">5</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">INT (魔法威力)</span>
                        <span class="text-2xl font-black text-blue-600" id="status-int">5</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">DEX (器用さ)</span>
                        <span class="text-2xl font-black text-green-600" id="status-dex">5</span>
                    </div>
                </div>
            </div>

            <!-- Detailed Stats -->
            <div class="bg-slate-800 rounded-3xl p-6 text-white mb-6">
                <div class="flex items-center justify-between mb-4 border-b border-slate-700 pb-2">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-tighter">Secondary Attributes</h3>
                    <button id="secondary-info-btn" class="text-slate-400 hover:text-white transition-colors text-xs font-bold flex items-center gap-1">
                        <i class="fas fa-circle-info"></i> Info
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>最大HP</span><span id="stat-max-hp">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>HP効率</span><span id="stat-hp-eff">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>最大MP</span><span id="stat-max-mp">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>MP効率</span><span id="stat-mp-eff">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>HP自動回復</span><span id="stat-hp-regen">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>MP自動回復</span><span id="stat-mp-regen">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>攻撃力</span><span id="stat-atk-flat">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>攻撃効率</span><span id="stat-atk-eff">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>防御力</span><span id="stat-def-flat">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>防御効率</span><span id="stat-def-eff">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>命中率</span><span id="stat-accuracy">95%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>会心率</span><span id="stat-crit">5%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>会心ダメージ</span><span id="stat-crit-dmg">200%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>与ダメ増加</span><span id="stat-dmg-boost">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>被ダメ軽減</span><span id="stat-dmg-reduction">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>回避率</span><span id="stat-eva">3%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>吸血率</span><span id="stat-leech">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>魔法貫通</span><span id="stat-m-pen">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>追加経験値</span><span id="stat-exp-boost">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ドロップ率</span><span id="stat-luck">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>レアドロ率</span><span id="stat-rare-find">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>Affix率</span><span id="stat-affix-find">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ゴールド増加率</span><span id="stat-gold-boost">0%</span></div>
                </div>
            </div>

            <!-- Equipment -->
            <div class="space-y-3 mb-12">
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-sword"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Weapon Slot</div>
                        <div id="equip-weapon" class="font-bold truncate text-sm">なし</div>
                    </div>
                    <div id="weapon-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-shield-halved"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Armor Slot</div>
                        <div id="equip-armor" class="font-bold truncate text-sm">なし</div>
                    </div>
                    <div id="armor-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-helmet-safety"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Helm Slot</div>
                        <div id="equip-head" class="font-bold truncate text-sm">なし</div>
                    </div>
                    <div id="head-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-hand"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Hand Slot</div>
                        <div id="equip-hands" class="font-bold truncate text-sm">なし</div>
                    </div>
                    <div id="hands-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-shoe-prints"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Foot Slot</div>
                        <div id="equip-feet" class="font-bold truncate text-sm">なし</div>
                    </div>
                    <div id="feet-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-gem"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Accessory Slot 1</div>
                        <div id="equip-accessory1" class="font-bold truncate text-sm">なし</div>
                    </div>
                    <div id="accessory1-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-gem"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Accessory Slot 2</div>
                        <div id="equip-accessory2" class="font-bold truncate text-sm">なし</div>
                    </div>
                    <div id="accessory2-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <button id="rest-btn" class="w-full py-4 bg-green-500 text-white font-black rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 mt-4">
                    <i class="fas fa-bed"></i> 休息して全回復する
                </button>
            </div>
        </section>

        <!-- SKILL PAGE -->
        <section id="page-skill" class="page bg-slate-50 flex-col h-full min-h-0">
            <div class="p-4 bg-white border-b shrink-0">
                <div class="flex justify-between items-center mb-4 px-1">
                    <h2 class="text-xl font-black">スキルツリー</h2>
                    <div class="text-sm font-bold bg-amber-100 text-amber-700 px-3 py-1 rounded-full">SP: <span id="skill-sp-display">0</span></div>
                </div>
                <!-- Job Select -->
                <div class="flex items-center gap-2">
                    <div class="text-slate-400 text-sm"><i class="fas fa-briefcase"></i></div>
                    <select id="job-select" onchange="switchJob(this.value)" class="flex-1 border border-slate-200 rounded-xl px-3 py-2 text-sm font-bold text-slate-700 bg-slate-50">
                        <option value="warrior">戦士</option>
                        <option value="mage">魔術師</option>
                        <option value="thief">盗賊</option>
                        <option value="ranger">レンジャー</option>
                        <option value="paladin">聖騎士</option>
                        <option value="monk">拳闘士</option>
                    </select>
                </div>
            </div>
            <div class="flex bg-white shrink-0 shadow-sm">
                <button onclick="switchSkillType('active')" id="tab-active" class="type-tab flex-1 py-3 text-sm text-slate-400 transition-all">アクティブ</button>
                <button onclick="switchSkillType('passive')" id="tab-passive" class="type-tab flex-1 py-3 text-sm text-slate-400 transition-all">パッシブ</button>
            </div>
            <div class="px-4 py-3 bg-white border-b shrink-0">
                <div class="flex items-center justify-between mb-1">
                    <div class="text-xs font-black">アクティブスロット</div>
                    <div class="text-[9px] text-slate-400">タップでスロット選択</div>
                </div>
                <div id="skill-slot-settings" class="grid grid-cols-2 gap-1.5"></div>
            </div>
            <div id="skill-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-8 min-h-0"></div>
        </section>

        <!-- INVENTORY PAGE -->
        <section id="page-inventory" class="page p-4 bg-slate-50">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-xl font-black flex items-center gap-2"><i class="fas fa-box-open"></i> 持ち物</h2>
                <span class="text-[10px] font-bold text-slate-400 bg-slate-200 px-2 py-0.5 rounded-full"><span id="inv-count">0</span> / ∞</span>
            </div>
            <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2 pb-12"></div>
            <div class="bg-white rounded-2xl border p-3 mt-3 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-[10px] font-black text-slate-400">並び替え</div>
                    <div class="flex items-center gap-2">
                        <button id="inv-sort-toggle" onclick="toggleInventorySort()" class="px-3 py-2 rounded-xl border text-[10px] font-black flex items-center gap-2 bg-slate-50 text-slate-500 border-slate-200">
                            <i class="fas fa-clock"></i>
                            <span id="inv-sort-label">入手順</span>
                        </button>
                        <button id="loot-filter-open" class="px-3 py-2 rounded-xl border text-[10px] font-black flex items-center gap-2 bg-slate-50 text-slate-500 border-slate-200">
                            <i class="fas fa-filter"></i>
                            <span>取得設定</span>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-[10px] font-bold">
                    <button data-inv-filter="all" onclick="setInventoryFilter('all')" class="inv-filter-btn py-2 rounded-xl border">全て</button>
                    <button data-inv-filter="weapon" onclick="setInventoryFilter('weapon')" class="inv-filter-btn py-2 rounded-xl border">武器</button>
                    <button data-inv-filter="armor" onclick="setInventoryFilter('armor')" class="inv-filter-btn py-2 rounded-xl border">鎧</button>
                    <button data-inv-filter="head" onclick="setInventoryFilter('head')" class="inv-filter-btn py-2 rounded-xl border">兜</button>
                    <button data-inv-filter="hands" onclick="setInventoryFilter('hands')" class="inv-filter-btn py-2 rounded-xl border">手</button>
                    <button data-inv-filter="feet" onclick="setInventoryFilter('feet')" class="inv-filter-btn py-2 rounded-xl border">足</button>
                    <button data-inv-filter="accessory" onclick="setInventoryFilter('accessory')" class="inv-filter-btn py-2 rounded-xl border col-span-3">装飾品</button>
                </div>
            </div>
        </section>

        <!-- LOG PAGE -->
        <section id="page-log" class="page p-4 bg-slate-900 text-slate-300 font-mono text-[10px]">
            <h2 class="text-slate-500 border-b border-slate-800 pb-2 mb-2 uppercase tracking-widest font-black">System History Log</h2>
            <div id="full-log-container" class="flex-1 overflow-y-auto space-y-1"></div>
        </section>

        <!-- HELP PAGE -->
        <section id="page-help" class="page p-4 bg-slate-50">
            <h2 class="text-xl font-black mb-4 flex items-center gap-2 px-2"><i class="fas fa-circle-question"></i> ヘルプ</h2>
            <div class="bg-white rounded-3xl p-6 shadow-sm space-y-4">
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">状態異常</div>
                    <p class="text-xs text-slate-500 mt-2">戦闘で発生する状態異常の効果一覧です。攻撃力/防御力のバフ・デバフ設計もここに整理しています。</p>
                </div>
                <div class="space-y-4 text-sm">
                    <div class="border border-slate-100 rounded-2xl p-4 bg-slate-50">
                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">攻撃力/防御力バフ・デバフ設計</div>
                        <div class="mt-3 grid gap-3">
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-white flex items-center justify-center text-emerald-500"><i class="fas fa-arrow-up-long"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">闘志 (攻撃力アップ)</div>
                                    <div class="text-xs text-slate-500">1スタックごとに攻撃力+10%。最大5スタック。再付与でターン延長。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-white flex items-center justify-center text-rose-500"><i class="fas fa-arrow-down-long"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">衰弱 (攻撃力ダウン)</div>
                                    <div class="text-xs text-slate-500">1スタックごとに攻撃力-10%。最大5スタック。防御側の行動で解除されやすい。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-white flex items-center justify-center text-sky-500"><i class="fas fa-shield-halved"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">守勢 (防御力アップ)</div>
                                    <div class="text-xs text-slate-500">1スタックごとに防御力+12%。最大4スタック。被ダメ軽減と乗算。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-white flex items-center justify-center text-amber-500"><i class="fas fa-shield"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">脆甲 (防御力ダウン)</div>
                                    <div class="text-xs text-slate-500">1スタックごとに防御力-12%。最大4スタック。貫通系と相性が良い。</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-[11px] text-slate-500">
                            <span class="font-bold text-slate-600">運用ルール例:</span> 効果は「基礎攻撃/防御 × (1 + 合計補正)」で計算。バフとデバフは合算後に上限・下限を設定。
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-skull-crossbones"></i></div>
                        <div>
                            <div class="font-black text-slate-700">毒</div>
                            <div class="text-xs text-slate-500">ターン開始時にスタック数ぶんのダメージ。</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-droplet"></i></div>
                        <div>
                            <div class="font-black text-slate-700">出血</div>
                            <div class="text-xs text-slate-500">ターン開始時にスタック数ぶんのダメージ。</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-down-long"></i></div>
                        <div>
                            <div class="font-black text-slate-700">弱体</div>
                            <div class="text-xs text-slate-500">能力が低下する状態。</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-shield-halved"></i></div>
                        <div>
                            <div class="font-black text-slate-700">脆弱</div>
                            <div class="text-xs text-slate-500">被ダメージが増加する状態。</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-arrow-up-long"></i></div>
                        <div>
                            <div class="font-black text-slate-700">強化</div>
                            <div class="text-xs text-slate-500">能力が上昇する状態。</div>
                        </div>
                    </div>
                    <div class="border-t border-slate-100 pt-4 space-y-3">
                        <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">その他の面白い状態異常案</div>
                        <div class="grid gap-3">
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-bolt"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">感電</div>
                                    <div class="text-xs text-slate-500">行動時に追加ダメージ。連鎖で周囲にも伝播。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-snowflake"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">凍結</div>
                                    <div class="text-xs text-slate-500">1ターン行動不能。被ダメージで解除。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-eye-slash"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">暗闇</div>
                                    <div class="text-xs text-slate-500">命中率低下。会心率も減少。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-hand-sparkles"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">沈黙</div>
                                    <div class="text-xs text-slate-500">魔法/スキル使用不可。通常攻撃のみ。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-person-running"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">迅速</div>
                                    <div class="text-xs text-slate-500">行動順が早くなる。回避率も少し上昇。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-layer-group"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">バリア</div>
                                    <div class="text-xs text-slate-500">一定量のダメージを吸収。残量が見えるタイプ。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-retweet"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">反射</div>
                                    <div class="text-xs text-slate-500">被弾時に一部ダメージを攻撃者へ返す。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-fire"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">燃焼</div>
                                    <div class="text-xs text-slate-500">ターン終了時にダメージ。回復効果が低下。</div>
                                </div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-user-slash"></i></div>
                                <div>
                                    <div class="font-black text-slate-700">挑発</div>
                                    <div class="text-xs text-slate-500">ターゲット固定。防御行動と組み合わせると戦略的。</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- BOTTOM NAV -->
    <nav class="h-16 border-t bg-white grid grid-cols-6 shrink-0 items-center pb-1 z-50 relative shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button onclick="switchPage('battle')" id="nav-battle" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-hand-fist text-xl"></i><span class="text-[9px] font-black">戦闘</span>
        </button>
        <button onclick="switchPage('status')" id="nav-status" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-user-circle text-xl"></i><span class="text-[9px] font-black">能力</span>
        </button>
        <button onclick="switchPage('skill')" id="nav-skill" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all relative">
            <i class="fas fa-star text-xl"></i><span class="text-[9px] font-black">スキル</span>
            <div id="nav-sp-dot" class="absolute top-3 right-6 w-2 h-2 bg-amber-500 rounded-full border-2 border-white hidden"></div>
        </button>
        <button onclick="switchPage('inventory')" id="nav-inventory" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all relative">
            <i class="fas fa-box-open text-xl"></i><span class="text-[9px] font-black">装備</span>
        </button>
        <button onclick="switchPage('log')" id="nav-log" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-scroll text-xl"></i><span class="text-[9px] font-black">履歴</span>
        </button>
        <button onclick="switchPage('help')" id="nav-help" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-circle-question text-xl"></i><span class="text-[9px] font-black">ヘルプ</span>
        </button>
    </nav>

    <!-- LOOT MODAL -->
    <div id="loot-modal" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-[2rem] overflow-hidden shadow-2xl transform scale-100 p-8 text-center border-b-8 border-slate-200">
            <div class="text-6xl mb-6">📦</div>
            <h3 class="font-black text-xl mb-2">戦利品を発見！</h3>
            <div id="loot-display" class="bg-slate-50 rounded-2xl p-6 my-4 border border-slate-100"></div>
            <div class="flex gap-3">
                <button onclick="closeLoot(false)" class="flex-1 py-4 text-sm font-bold text-slate-400 bg-slate-100 rounded-2xl">捨てる</button>
                <button onclick="closeLoot(true)" class="flex-1 py-4 text-sm font-bold text-white bg-slate-800 rounded-2xl shadow-lg">拾う</button>
            </div>
        </div>
    </div>

    <!-- LOOT FILTER MODAL -->
    <div id="loot-filter-modal" class="fixed inset-0 bg-slate-900/80 z-[105] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                    <i class="fas fa-filter text-slate-500"></i> 取得フィルター
                </h3>
                <button id="loot-filter-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <p class="text-xs text-slate-500 mb-4">チェックしたレア度は拾わず、削除扱いにします。</p>
            <div class="space-y-2 text-sm">
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-normal">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="normal">
                        ノーマル
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">拾わない</span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-magic">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="magic">
                        マジック
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">拾わない</span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-rare">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="rare">
                        レア
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">拾わない</span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-epic">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="epic">
                        エピック
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">拾わない</span>
                </label>
                <label class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-xl px-3 py-2">
                    <span class="flex items-center gap-2 font-bold rarity-legendary">
                        <input type="checkbox" class="loot-filter-checkbox accent-slate-800" data-rarity="legendary">
                        レジェンダリー
                    </span>
                    <span class="text-[10px] text-slate-400 font-bold">拾わない</span>
                </label>
            </div>
            <button id="loot-filter-close-bottom" class="mt-5 w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg">閉じる</button>
        </div>
    </div>

    <!-- STATUS INFO MODAL -->
    <div id="status-info-modal" class="fixed inset-0 bg-slate-900/80 z-[110] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                    <i class="fas fa-circle-info text-slate-500"></i> ステータスメモ
                </h3>
                <button id="status-info-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="space-y-4 text-xs text-slate-600">
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase">Primary</div>
                    <ul class="mt-2 space-y-1">
                        <li><span class="font-bold text-slate-700">STR</span>：物理攻撃の基礎値。武器のATKと合算されます。</li>
                        <li><span class="font-bold text-slate-700">VIT</span>：被ダメージ軽減の基礎値。防具DEFと合算されます。</li>
                        <li><span class="font-bold text-slate-700">INT</span>：魔法攻撃の基礎値。回復量にも影響。</li>
                        <li><span class="font-bold text-slate-700">DEX</span>：器用さの基礎値。装備厳選の目安に利用。</li>
                    </ul>
                </div>
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase">Secondary</div>
                    <ul class="mt-2 space-y-1">
                        <li>最大HP：HPを固定値で増加。</li>
                        <li>HP効率：最大HPを%で増加。</li>
                        <li>最大MP：MPを固定値で増加。</li>
                        <li>MP効率：最大MPを%で増加。</li>
                        <li>HP自動回復：ターン終了時にHPが回復。</li>
                        <li>MP自動回復：ターン終了時にMPが回復。</li>
                        <li>攻撃力：物理攻撃の固定増加。</li>
                        <li>攻撃効率：物理攻撃を%で増加。</li>
                        <li>防御力：防御の固定増加。</li>
                        <li>防御効率：防御を%で増加。</li>
                        <li>命中率：攻撃が命中する確率。</li>
                        <li>会心率：クリティカルが発生する確率。</li>
                        <li>会心ダメージ：会心時のダメージ倍率。</li>
                        <li>与ダメ増加：通常攻撃・スキル全体の与ダメ補正。</li>
                        <li>被ダメ軽減：敵攻撃の最終ダメージを軽減。</li>
                        <li>回避率：敵の攻撃を回避する確率。</li>
                        <li>吸血率：与えたダメージの一部をHP回復。</li>
                        <li>魔法貫通：敵の防御を無視する割合（魔法系スキル向け）。</li>
                        <li>追加経験値：獲得経験値の増加率。</li>
                        <li>ドロップ率：戦利品が出る確率の上昇。</li>
                        <li>レアドロ率：ドロップ品のレア度上昇確率。</li>
                        <li>Affix率：装備にAffixが付与される確率とランク上昇率。</li>
                        <li>ゴールド増加率：獲得ゴールドの増加率。</li>
                    </ul>
                </div>
            </div>
            <button id="status-info-close-bottom" class="mt-5 w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg">閉じる</button>
        </div>
    </div>

    <!-- STATUS EFFECT MODAL -->
    <div id="status-effect-modal" class="fixed inset-0 bg-slate-900/80 z-[120] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 id="status-effect-title" class="font-black text-lg text-slate-800 flex items-center gap-2"></h3>
                <button id="status-effect-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <p id="status-effect-desc" class="text-xs text-slate-600"></p>
            <div class="mt-4 flex items-center justify-between text-xs text-slate-500">
                <span id="status-effect-stacks"></span>
                <span id="status-effect-turns"></span>
            </div>
            <button id="status-effect-close-bottom" class="mt-5 w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg">閉じる</button>
        </div>
    </div>

    <script>
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (e) {
            const now = Date.now();
            const interactiveTarget = e.target.closest('button, a, input, select, textarea, label');
            if (!interactiveTarget && now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        // --- DATA STRUCTURE ---
        const Game = {
            floor: 1,
            state: 'idle',
            player: {
                level: 1,
                hp: 100, maxHp: 100, mp: 30, maxMp: 30,
                // Primary Stats
                str: 10, vit: 5, int: 5, dex: 5,
                // Secondary Stats (calculated)
                maxHpFlat: 0, hpEfficiency: 0, maxMpFlat: 0, mpEfficiency: 0,
                attackFlat: 0, attackEfficiency: 0, defenseFlat: 0, defenseEfficiency: 0,
                hpRegen: 0, mpRegen: 0, goldBoost: 0,
                critRate: 5, evasionRate: 3, leechRate: 0, expBoost: 0, mPen: 0, luck: 50, accuracy: 95,
                critDamage: 200, damageBoost: 0, damageReduction: 0, rareFind: 0, affixFind: 0,
                exp: 0, next: 100, sp: 0,
                gold: 0,
                weapon: null, armor: null, head: null, hands: null, feet: null, accessory1: null, accessory2: null, inventory: [],
                skillSlots: [null, null, null, null],
                skillSlotIndex: 0,
                skillSlotTarget: 0,
                statusEffects: [],
                skills: {
                    warrior: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    mage: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    thief: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    ranger: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    paladin: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    monk: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] }
                }
            },
            currentJobTab: 'warrior',
            currentSkillType: 'active',
            inventoryFilter: 'all',
            inventorySort: 'acquired',
            inventoryCounter: 0,
            lootFilter: { normal: false, magic: false, rare: false, epic: false, legendary: false },
            enemy: null, logs: []
        };

        const JobKeys = ['warrior', 'mage', 'thief', 'ranger', 'paladin', 'monk'];

        const JobData = {
            warrior: {
                name: "戦士",
                active: [
                    { id: 0, name: "パワースラッシュ", mp: 4, mpGrowth: 0, pow: 1.6, powGrowth: 0.25, maxLevel: 5, desc: "力で叩き込む一撃。Lvで威力上昇" },
                    { id: 1, name: "シールドバッシュ", mp: 6, mpGrowth: 0, pow: 1.1, powGrowth: 0.2, accuracyBonus: 10, accuracyGrowth: 5, maxLevel: 5, desc: "盾で叩き、命中率が高い" },
                    { id: 2, name: "バーサク", mp: 10, pow: 2.2, powGrowth: 0.35, hpCost: 0.08, maxLevel: 5, desc: "HPを消費して高火力を叩き出す" },
                    { id: 3, name: "鼓舞", mp: 8, val: 30, valGrowth: 12, type: 'heal', maxLevel: 5, desc: "気合でHPを回復する" },
                    { id: 4, name: "鉄壁の構え", mp: 12, pow: 0.6, powGrowth: 0.12, maxLevel: 5, desc: "堅い一撃で持久戦に強い" },
                    { id: 5, name: "ドラゴンスレイヤー", mp: 25, pow: 4.5, powGrowth: 0.7, maxLevel: 5, desc: "渾身の斬撃。Lvで超火力" }
                ],
                passive: [
                    { id: 0, name: "筋力増強", desc: "STR+3/レベル", maxLevel: 5, apply: (d) => Game.player.str += 3 * d },
                    { id: 1, name: "頑強", desc: "VIT+3/レベル", maxLevel: 5, apply: (d) => Game.player.vit += 3 * d },
                    { id: 2, name: "血の渇望", desc: "吸血率+2%/レベル", maxLevel: 5, apply: (d) => Game.player.leechRate += 2 * d },
                    { id: 3, name: "反撃の構え", desc: "被弾時の反撃率が上昇", maxLevel: 5, logic: 'counter' },
                    { id: 4, name: "鉄壁装備", desc: "防具で受けるダメージがさらに減少", maxLevel: 5, logic: 'armor_boost' },
                    { id: 5, name: "不屈の闘志", desc: "HP30%以下で攻撃力上昇", maxLevel: 5, logic: 'low_hp_boost' }
                ]
            },
            mage: {
                name: "魔術師",
                active: [
                    { id: 0, name: "ファイアボール", mp: 8, pow: 2.0, powGrowth: 0.3, isMagic: true, maxLevel: 5, desc: "燃え上がる火球で焼き払う" },
                    { id: 1, name: "アイスランス", mp: 10, pow: 2.3, powGrowth: 0.35, isMagic: true, accuracyBonus: 5, accuracyGrowth: 3, maxLevel: 5, desc: "鋭い氷槍で貫く" },
                    { id: 2, name: "マナドレイン", mp: 0, pow: 0.7, powGrowth: 0.1, isMagic: true, mpHeal: 0.4, mpHealGrowth: 0.05, maxLevel: 5, desc: "与ダメに応じてMPを吸収" },
                    { id: 3, name: "サンダーストーム", mp: 18, pow: 3.2, powGrowth: 0.45, isMagic: true, maxLevel: 5, desc: "雷撃を叩きつける広範囲魔法" },
                    { id: 4, name: "メテオ", mp: 30, pow: 5.0, powGrowth: 0.8, isMagic: true, maxLevel: 5, desc: "隕石を召喚する大魔法" },
                    { id: 5, name: "終焉の禁呪", mp: 50, pow: 10.0, powGrowth: 1.2, isMagic: true, maxLevel: 5, desc: "魔力を解き放つ禁呪" }
                ],
                passive: [
                    { id: 0, name: "知力増強", desc: "INT+4/レベル", maxLevel: 5, apply: (d) => Game.player.int += 4 * d },
                    { id: 1, name: "魔力循環", desc: "最大MP+15/レベル", maxLevel: 5, apply: (d) => { Game.player.maxMpFlat += 15 * d; } },
                    { id: 2, name: "瞑想", desc: "MP自動回復+2/レベル", maxLevel: 5, apply: (d) => Game.player.mpRegen += 2 * d },
                    { id: 3, name: "魔導集中", desc: "会心率+2%/レベル", maxLevel: 5, apply: (d) => Game.player.critRate += 2 * d },
                    { id: 4, name: "魔力貫通", desc: "魔法貫通+4%/レベル", maxLevel: 5, apply: (d) => Game.player.mPen += 4 * d },
                    { id: 5, name: "秘奥強化", desc: "与ダメ増加+2%/レベル", maxLevel: 5, apply: (d) => Game.player.damageBoost += 2 * d }
                ]
            },
            thief: {
                name: "盗賊",
                active: [
                    { id: 0, name: "クイックスタブ", mp: 3, pow: 1.0, powGrowth: 0.15, accuracyBonus: 15, accuracyGrowth: 5, maxLevel: 5, desc: "素早い突きで確実に削る" },
                    { id: 1, name: "ダブルアタック", mp: 7, pow: 0.85, powGrowth: 0.1, hits: 2, maxLevel: 5, desc: "二連撃で手数を稼ぐ" },
                    { id: 2, name: "毒の刃", mp: 10, pow: 1.8, powGrowth: 0.25, critBonus: 5, critGrowth: 2, maxLevel: 5, desc: "急所狙いで会心率上昇" },
                    { id: 3, name: "強奪", mp: 5, pow: 1.0, powGrowth: 0.1, expBonus: 15, expBonusGrowth: 5, maxLevel: 5, desc: "攻撃しながら経験値を奪う" },
                    { id: 4, name: "影縫い", mp: 12, pow: 2.2, powGrowth: 0.3, maxLevel: 5, desc: "影から一撃を加える" },
                    { id: 5, name: "千手観音", mp: 30, pow: 1.1, powGrowth: 0.1, hits: 5, maxLevel: 5, desc: "圧倒的な五連撃" }
                ],
                passive: [
                    { id: 0, name: "俊敏", desc: "DEX+3/レベル", maxLevel: 5, apply: (d) => Game.player.dex += 3 * d },
                    { id: 1, name: "神速回避", desc: "回避率+2%/レベル", maxLevel: 5, apply: (d) => Game.player.evasionRate += 2 * d },
                    { id: 2, name: "目利き", desc: "ドロップ率+3%/レベル", maxLevel: 5, apply: (d) => Game.player.luck += 3 * d },
                    { id: 3, name: "幸運の女神", desc: "追加経験値+5%/レベル", maxLevel: 5, apply: (d) => Game.player.expBoost += 5 * d },
                    { id: 4, name: "急所攻撃", desc: "会心率+3%/レベル", maxLevel: 5, apply: (d) => Game.player.critRate += 3 * d },
                    { id: 5, name: "暗殺者の心得", desc: "満タンの敵への初撃が強化", maxLevel: 5, logic: 'first_hit_boost' }
                ]
            },
            ranger: {
                name: "レンジャー",
                active: [
                    { id: 0, name: "プレシジョンショット", mp: 5, pow: 1.5, powGrowth: 0.2, accuracyBonus: 15, accuracyGrowth: 5, maxLevel: 5, desc: "狙いすました一射" },
                    { id: 1, name: "トリプルショット", mp: 10, pow: 0.8, powGrowth: 0.1, hits: 3, maxLevel: 5, desc: "三連射で圧倒する" },
                    { id: 2, name: "ブラッドアロー", mp: 8, pow: 1.3, powGrowth: 0.2, leech: 8, leechGrowth: 2, maxLevel: 5, desc: "与ダメの一部を吸収する矢" },
                    { id: 3, name: "爆裂矢", mp: 16, pow: 2.6, powGrowth: 0.4, maxLevel: 5, desc: "爆発で敵を貫く強撃" },
                    { id: 4, name: "ハンターズラッシュ", mp: 18, pow: 1.0, powGrowth: 0.1, hits: 4, maxLevel: 5, desc: "連射で削り続ける" },
                    { id: 5, name: "テンペストボレー", mp: 32, pow: 1.4, powGrowth: 0.15, hits: 6, maxLevel: 5, desc: "嵐のような矢の雨" }
                ],
                passive: [
                    { id: 0, name: "射撃訓練", desc: "命中率+3%/レベル", maxLevel: 5, apply: (d) => Game.player.accuracy += 3 * d },
                    { id: 1, name: "クリティカルアイ", desc: "会心率+2%/レベル", maxLevel: 5, apply: (d) => Game.player.critRate += 2 * d },
                    { id: 2, name: "集中", desc: "与ダメ増加+2%/レベル", maxLevel: 5, apply: (d) => Game.player.damageBoost += 2 * d },
                    { id: 3, name: "野生の勘", desc: "回避率+1%/レベル", maxLevel: 5, apply: (d) => Game.player.evasionRate += 1 * d },
                    { id: 4, name: "レアハント", desc: "レアドロ率+3%/レベル", maxLevel: 5, apply: (d) => Game.player.rareFind += 3 * d },
                    { id: 5, name: "獲物の追跡", desc: "ゴールド増加率+5%/レベル", maxLevel: 5, apply: (d) => Game.player.goldBoost += 5 * d }
                ]
            },
            paladin: {
                name: "聖騎士",
                active: [
                    { id: 0, name: "ホーリースマイト", mp: 6, pow: 1.7, powGrowth: 0.25, isMagic: true, maxLevel: 5, desc: "聖なる衝撃で浄化する" },
                    { id: 1, name: "シールドチャージ", mp: 8, pow: 1.3, powGrowth: 0.2, accuracyBonus: 10, accuracyGrowth: 5, maxLevel: 5, desc: "盾で突撃し敵を崩す" },
                    { id: 2, name: "セイクリッドヒール", mp: 12, val: 40, valGrowth: 15, type: 'heal', isMagic: true, maxLevel: 5, desc: "聖なる力でHPを回復" },
                    { id: 3, name: "ライトバースト", mp: 18, pow: 2.8, powGrowth: 0.4, isMagic: true, maxLevel: 5, desc: "眩い光で敵を撃つ" },
                    { id: 4, name: "ジャッジメント", mp: 22, pow: 2.0, powGrowth: 0.3, isMagic: true, hits: 2, maxLevel: 5, desc: "聖なる裁きを連撃で与える" },
                    { id: 5, name: "聖域の裁き", mp: 35, pow: 4.8, powGrowth: 0.7, isMagic: true, maxLevel: 5, desc: "聖域の光が降り注ぐ一撃" }
                ],
                passive: [
                    { id: 0, name: "信仰", desc: "最大HP+15/レベル", maxLevel: 5, apply: (d) => Game.player.maxHpFlat += 15 * d },
                    { id: 1, name: "聖なる守り", desc: "被ダメ軽減+2%/レベル", maxLevel: 5, apply: (d) => Game.player.damageReduction += 2 * d },
                    { id: 2, name: "聖癒力", desc: "HP自動回復+2/レベル", maxLevel: 5, apply: (d) => Game.player.hpRegen += 2 * d },
                    { id: 3, name: "敬虔", desc: "MP自動回復+1/レベル", maxLevel: 5, apply: (d) => Game.player.mpRegen += 1 * d },
                    { id: 4, name: "神罰", desc: "与ダメ増加+2%/レベル", maxLevel: 5, apply: (d) => Game.player.damageBoost += 2 * d },
                    { id: 5, name: "守護誓約", desc: "防御効率+4%/レベル", maxLevel: 5, apply: (d) => Game.player.defenseEfficiency += 4 * d }
                ]
            },
            monk: {
                name: "拳闘士",
                active: [
                    { id: 0, name: "連打拳", mp: 4, pow: 0.7, powGrowth: 0.1, hits: 3, maxLevel: 5, desc: "素早い連打で削る" },
                    { id: 1, name: "気功波", mp: 8, pow: 1.8, powGrowth: 0.25, maxLevel: 5, desc: "気を飛ばして攻撃する" },
                    { id: 2, name: "破岩撃", mp: 10, pow: 2.4, powGrowth: 0.3, maxLevel: 5, desc: "岩をも砕く一撃" },
                    { id: 3, name: "回天脚", mp: 12, pow: 1.0, powGrowth: 0.15, hits: 4, accuracyBonus: 10, accuracyGrowth: 5, maxLevel: 5, desc: "回転蹴りで連撃" },
                    { id: 4, name: "活力循環", mp: 10, val: 25, valGrowth: 10, type: 'heal', maxLevel: 5, desc: "内なる気でHPを回復" },
                    { id: 5, name: "無我の境地", mp: 30, pow: 3.8, powGrowth: 0.6, critBonus: 10, critGrowth: 3, maxLevel: 5, desc: "集中して渾身の一撃" }
                ],
                passive: [
                    { id: 0, name: "体術鍛錬", desc: "STR+2/レベル & DEX+2/レベル", maxLevel: 5, apply: (d) => { Game.player.str += 2 * d; Game.player.dex += 2 * d; } },
                    { id: 1, name: "気の流れ", desc: "HP効率+3%/レベル", maxLevel: 5, apply: (d) => Game.player.hpEfficiency += 3 * d },
                    { id: 2, name: "内功", desc: "MP効率+3%/レベル", maxLevel: 5, apply: (d) => Game.player.mpEfficiency += 3 * d },
                    { id: 3, name: "闘志", desc: "会心ダメージ+8%/レベル", maxLevel: 5, apply: (d) => Game.player.critDamage += 8 * d },
                    { id: 4, name: "霞身", desc: "回避率+2%/レベル", maxLevel: 5, apply: (d) => Game.player.evasionRate += 2 * d },
                    { id: 5, name: "闘気吸収", desc: "吸血率+2%/レベル", maxLevel: 5, apply: (d) => Game.player.leechRate += 2 * d }
                ]
            }
        };

        const StatusDefs = {
            poison: { id: 'poison', name: '毒', effectType: 'poison', stackable: true, maxStacks: 5, defaultTurns: 3, icon: 'fa-skull-crossbones', desc: 'ターン開始時に最大HPの3%×スタックのダメージ。' },
            bleed: { id: 'bleed', name: '出血', effectType: 'bleed', stackable: true, maxStacks: 5, defaultTurns: 3, icon: 'fa-droplet', desc: 'ターン開始時に(固定2+STR×0.3)×スタックのダメージ。' },
            weaken: { id: 'weaken', name: '弱体', effectType: 'weaken', stackable: true, maxStacks: 5, defaultTurns: 2, icon: 'fa-down-long', desc: '与ダメが低下する。' },
            vulnerable: { id: 'vulnerable', name: '脆弱', effectType: 'vulnerable', stackable: true, maxStacks: 3, defaultTurns: 2, icon: 'fa-shield-halved', desc: '被ダメージが増加する状態。' },
            buff: { id: 'buff', name: '強化', effectType: 'buff', stackable: true, maxStacks: 3, defaultTurns: 2, icon: 'fa-arrow-up-long', desc: '与ダメが増加する。' },
            attackUp: { id: 'attackUp', name: '闘志', effectType: 'attackUp', stackable: true, maxStacks: 5, defaultTurns: 3, icon: 'fa-arrow-up-long', desc: '攻撃力が上昇する。' },
            attackDown: { id: 'attackDown', name: '衰弱', effectType: 'attackDown', stackable: true, maxStacks: 5, defaultTurns: 3, icon: 'fa-arrow-down-long', desc: '攻撃力が低下する。' },
            defenseUp: { id: 'defenseUp', name: '守勢', effectType: 'defenseUp', stackable: true, maxStacks: 4, defaultTurns: 3, icon: 'fa-shield-halved', desc: '防御力が上昇する。' },
            defenseDown: { id: 'defenseDown', name: '脆甲', effectType: 'defenseDown', stackable: true, maxStacks: 4, defaultTurns: 3, icon: 'fa-shield', desc: '防御力が低下する。' },
            freeze: { id: 'freeze', name: '凍結', effectType: 'freeze', stackable: false, maxStacks: 1, defaultTurns: 1, icon: 'fa-snowflake', desc: '行動不能。被ダメージで解除。' },
            blind: { id: 'blind', name: '暗闇', effectType: 'blind', stackable: true, maxStacks: 3, defaultTurns: 3, icon: 'fa-eye-slash', desc: '命中率と会心率が低下する。' },
            silence: { id: 'silence', name: '沈黙', effectType: 'silence', stackable: false, maxStacks: 1, defaultTurns: 2, icon: 'fa-hand-sparkles', desc: 'スキル使用不可。' },
            haste: { id: 'haste', name: '迅速', effectType: 'haste', stackable: true, maxStacks: 3, defaultTurns: 3, icon: 'fa-person-running', desc: '命中率と回避率が上昇する。' },
            barrier: { id: 'barrier', name: 'バリア', effectType: 'barrier', stackable: true, maxStacks: 3, defaultTurns: 3, icon: 'fa-layer-group', shieldPerStack: 30, desc: '一定量のダメージを吸収する。' },
            reflect: { id: 'reflect', name: '反射', effectType: 'reflect', stackable: true, maxStacks: 3, defaultTurns: 2, icon: 'fa-retweet', desc: '被ダメージの一部を反射する。' },
            taunt: { id: 'taunt', name: '挑発', effectType: 'taunt', stackable: true, maxStacks: 2, defaultTurns: 2, icon: 'fa-user-slash', desc: 'ターゲットを引きつける。' }
        };

        const EnemyBases = [
            { name: "スライム", icon: "fa-bacteria", hp: 30, str: 7, exp: 12 },
            { name: "コウモリ", icon: "fa-moon", hp: 35, str: 10, exp: 15 },
            { name: "ゴブリン", icon: "fa-user-ninja", hp: 60, str: 14, exp: 25 },
            { name: "スケルトン", icon: "fa-skull", hp: 80, str: 20, exp: 40 },
            { name: "ゴーレム", icon: "fa-mountain", hp: 150, str: 25, exp: 70 },
            { name: "シャドウ", icon: "fa-ghost", hp: 200, str: 35, exp: 100 },
            { name: "ドラゴン", icon: "fa-dragon", hp: 500, str: 60, exp: 300 }
        ];

        const StatLabels = {
            str: "STR",
            vit: "VIT",
            int: "INT",
            dex: "DEX",
            maxHp: "最大HP",
            maxMp: "最大MP",
            maxHpFlat: "最大HP",
            maxMpFlat: "最大MP",
            hpEfficiency: "HP効率",
            mpEfficiency: "MP効率",
            attackFlat: "攻撃力",
            defenseFlat: "防御力",
            attackEfficiency: "攻撃効率",
            defenseEfficiency: "防御効率",
            hpRegen: "HP自動回復",
            mpRegen: "MP自動回復",
            critRate: "会心率",
            critDamage: "会心ダメージ",
            damageBoost: "与ダメ増加",
            damageReduction: "被ダメ軽減",
            evasionRate: "回避率",
            leechRate: "吸血率",
            expBoost: "追加経験値",
            mPen: "魔法貫通",
            luck: "ドロップ率",
            accuracy: "命中率",
            rareFind: "レアドロ率",
            affixFind: "Affix率",
            goldBoost: "ゴールド増加率"
        };

        const PercentStats = new Set([
            "hpEfficiency",
            "mpEfficiency",
            "attackEfficiency",
            "defenseEfficiency",
            "critRate",
            "critDamage",
            "damageBoost",
            "damageReduction",
            "evasionRate",
            "leechRate",
            "expBoost",
            "mPen",
            "luck",
            "accuracy",
            "rareFind",
            "affixFind",
            "goldBoost"
        ]);

        const RarityDefs = [
            { key: "normal", name: "ノーマル", mul: 1.0 },
            { key: "magic", name: "マジック", mul: 1.2 },
            { key: "rare", name: "レア", mul: 1.5 },
            { key: "epic", name: "エピック", mul: 2.0 },
            { key: "legendary", name: "レジェンダリー", mul: 5.0 }
        ];
        const RaritySortOrder = Object.fromEntries(RarityDefs.map((def, index) => [def.key, index]));
        const SellBasePrices = {
            normal: 1,
            magic: 10,
            rare: 1000,
            epic: 10000,
            legendary: 100000
        };
        const AffixRankMultipliers = {
            1: 1.2,
            2: 1.5,
            3: 2.0
        };

        const EquipmentTypeLabels = {
            weapon: "武器",
            armor: "鎧",
            head: "兜",
            hands: "手",
            feet: "足",
            accessory: "装飾品"
        };

        const InventorySortDefs = {
            acquired: { label: "入手順", icon: "fa-clock" },
            rarity: { label: "レア度順", icon: "fa-gem" },
            affix: { label: "Affix順", icon: "fa-star" }
        };

        const EquipmentTypePools = {
            weapon: "weapons",
            armor: "armors",
            head: "heads",
            hands: "hands",
            feet: "feet",
            accessory: "accessories"
        };

        const EquipmentTiers = [
            {
                floorStart: 1,
                weapons: [
                    { name: "旅人の剣", stats: [{ key: "attackFlat", value: 6 }, { key: "str", value: 2 }] },
                    { name: "見習いの短剣", stats: [{ key: "attackFlat", value: 5 }, { key: "dex", value: 3 }] },
                    { name: "木杖", stats: [{ key: "attackFlat", value: 4 }, { key: "int", value: 4 }] }
                ],
                armors: [
                    { name: "布のローブ", stats: [{ key: "defenseFlat", value: 4 }, { key: "maxMp", value: 10 }] },
                    { name: "革の胴着", stats: [{ key: "defenseFlat", value: 5 }, { key: "dex", value: 2 }, { key: "maxHp", value: 8 }] },
                    { name: "木の盾鎧", stats: [{ key: "defenseFlat", value: 6 }, { key: "vit", value: 2 }] }
                ],
                heads: [
                    { name: "旅人のフード", stats: [{ key: "defenseFlat", value: 2 }, { key: "maxMp", value: 6 }] },
                    { name: "革のキャップ", stats: [{ key: "defenseFlat", value: 3 }, { key: "dex", value: 2 }] },
                    { name: "木綿のヘルム", stats: [{ key: "defenseFlat", value: 3 }, { key: "vit", value: 1 }] }
                ],
                hands: [
                    { name: "旅人の手袋", stats: [{ key: "attackFlat", value: 2 }, { key: "dex", value: 1 }] },
                    { name: "革のグローブ", stats: [{ key: "defenseFlat", value: 2 }, { key: "dex", value: 2 }] },
                    { name: "布のミトン", stats: [{ key: "mpEfficiency", value: 2 }, { key: "int", value: 1 }] }
                ],
                feet: [
                    { name: "旅人のブーツ", stats: [{ key: "defenseFlat", value: 2 }, { key: "evasionRate", value: 1 }] },
                    { name: "革のブーツ", stats: [{ key: "defenseFlat", value: 3 }, { key: "dex", value: 1 }] },
                    { name: "軽歩の靴", stats: [{ key: "accuracy", value: 2 }, { key: "dex", value: 1 }] }
                ],
                accessories: [
                    { name: "素朴な指輪", stats: [{ key: "critRate", value: 1 }, { key: "str", value: 1 }] },
                    { name: "護りのペンダント", stats: [{ key: "damageReduction", value: 1 }, { key: "maxHp", value: 6 }] },
                    { name: "学徒のタリスマン", stats: [{ key: "mpEfficiency", value: 2 }, { key: "int", value: 2 }] }
                ]
            },
            {
                floorStart: 51,
                weapons: [
                    { name: "鋼の剣", stats: [{ key: "attackFlat", value: 12 }, { key: "str", value: 5 }] },
                    { name: "疾風の短剣", stats: [{ key: "attackFlat", value: 10 }, { key: "dex", value: 6 }] },
                    { name: "賢者の杖", stats: [{ key: "attackFlat", value: 9 }, { key: "int", value: 8 }] }
                ],
                armors: [
                    { name: "魔導ローブ", stats: [{ key: "defenseFlat", value: 9 }, { key: "maxMp", value: 25 }, { key: "int", value: 3 }] },
                    { name: "熟練の革鎧", stats: [{ key: "defenseFlat", value: 11 }, { key: "dex", value: 4 }, { key: "maxHp", value: 18 }] },
                    { name: "鋼鉄の鎧", stats: [{ key: "defenseFlat", value: 13 }, { key: "vit", value: 5 }] }
                ],
                heads: [
                    { name: "鋼の兜", stats: [{ key: "defenseFlat", value: 6 }, { key: "vit", value: 3 }] },
                    { name: "レンジャーハット", stats: [{ key: "defenseFlat", value: 5 }, { key: "dex", value: 4 }] },
                    { name: "魔導のサークレット", stats: [{ key: "defenseFlat", value: 4 }, { key: "int", value: 4 }, { key: "maxMp", value: 10 }] }
                ],
                hands: [
                    { name: "鋼のガントレット", stats: [{ key: "defenseFlat", value: 5 }, { key: "str", value: 3 }] },
                    { name: "疾風のグローブ", stats: [{ key: "attackFlat", value: 4 }, { key: "dex", value: 4 }] },
                    { name: "詠唱の手甲", stats: [{ key: "mpEfficiency", value: 4 }, { key: "int", value: 3 }] }
                ],
                feet: [
                    { name: "鋼のブーツ", stats: [{ key: "defenseFlat", value: 6 }, { key: "vit", value: 2 }] },
                    { name: "風切りの靴", stats: [{ key: "evasionRate", value: 2 }, { key: "dex", value: 3 }] },
                    { name: "巡礼の靴", stats: [{ key: "hpEfficiency", value: 3 }, { key: "maxHp", value: 10 }] }
                ],
                accessories: [
                    { name: "勇気の指輪", stats: [{ key: "critRate", value: 2 }, { key: "str", value: 3 }] },
                    { name: "守護の首飾り", stats: [{ key: "damageReduction", value: 2 }, { key: "maxHp", value: 15 }] },
                    { name: "知恵の護符", stats: [{ key: "mpEfficiency", value: 4 }, { key: "int", value: 4 }] }
                ]
            },
            {
                floorStart: 101,
                weapons: [
                    { name: "黒曜剣", stats: [{ key: "attackFlat", value: 20 }, { key: "str", value: 8 }, { key: "dex", value: 4 }] },
                    { name: "影刃", stats: [{ key: "attackFlat", value: 18 }, { key: "dex", value: 10 }] },
                    { name: "星詠みの杖", stats: [{ key: "attackFlat", value: 16 }, { key: "int", value: 12 }, { key: "maxMp", value: 15 }] }
                ],
                armors: [
                    { name: "星紡ぎのローブ", stats: [{ key: "defenseFlat", value: 15 }, { key: "maxMp", value: 40 }, { key: "int", value: 6 }] },
                    { name: "影纏いの胴着", stats: [{ key: "defenseFlat", value: 16 }, { key: "dex", value: 7 }, { key: "maxHp", value: 28 }] },
                    { name: "重厚なる鎧", stats: [{ key: "defenseFlat", value: 18 }, { key: "vit", value: 9 }, { key: "maxHp", value: 20 }] }
                ],
                heads: [
                    { name: "星冠のヘルム", stats: [{ key: "defenseFlat", value: 9 }, { key: "vit", value: 6 }] },
                    { name: "影縫いのフード", stats: [{ key: "defenseFlat", value: 8 }, { key: "dex", value: 6 }, { key: "evasionRate", value: 2 }] },
                    { name: "天文のサークレット", stats: [{ key: "defenseFlat", value: 7 }, { key: "int", value: 7 }, { key: "maxMp", value: 15 }] }
                ],
                hands: [
                    { name: "黒曜の籠手", stats: [{ key: "attackFlat", value: 7 }, { key: "str", value: 5 }] },
                    { name: "影走りのグローブ", stats: [{ key: "dex", value: 7 }, { key: "critRate", value: 2 }] },
                    { name: "星詠みの手甲", stats: [{ key: "mpEfficiency", value: 6 }, { key: "int", value: 6 }] }
                ],
                feet: [
                    { name: "重装のブーツ", stats: [{ key: "defenseFlat", value: 9 }, { key: "damageReduction", value: 2 }] },
                    { name: "影歩きの靴", stats: [{ key: "evasionRate", value: 3 }, { key: "dex", value: 6 }] },
                    { name: "神官の靴", stats: [{ key: "hpEfficiency", value: 4 }, { key: "maxHp", value: 18 }] }
                ],
                accessories: [
                    { name: "覇者の指輪", stats: [{ key: "critRate", value: 3 }, { key: "damageBoost", value: 2 }] },
                    { name: "星守の護符", stats: [{ key: "rareFind", value: 3 }, { key: "maxMp", value: 20 }] },
                    { name: "黒曜のペンダント", stats: [{ key: "damageReduction", value: 3 }, { key: "maxHp", value: 20 }] }
                ]
            }
        ];

        const PrefixAffixes = [
            { name: "鋭撃の", rank: 1, group: "attack", stats: ["str", "attackFlat", "accuracy", "critRate", "attackEfficiency"] },
            { name: "鉄壁の", rank: 1, group: "defense", stats: ["vit", "defenseFlat", "maxHp", "damageReduction", "hpRegen"] },
            { name: "幸運の", rank: 1, group: "treasure", stats: ["luck", "rareFind", "goldBoost", "expBoost", "affixFind"] },
            { name: "剛撃の", rank: 2, group: "attack", stats: ["str", "dex", "attackFlat", "critRate", "damageBoost", "critDamage"] },
            { name: "守護の", rank: 2, group: "defense", stats: ["vit", "defenseFlat", "defenseEfficiency", "maxHp", "evasionRate"] },
            { name: "豊穣の", rank: 2, group: "treasure", stats: ["luck", "rareFind", "affixFind", "goldBoost", "expBoost"] },
            { name: "覇王の", rank: 3, group: "attack", stats: ["str", "int", "attackFlat", "attackEfficiency", "damageBoost", "critDamage"] },
            { name: "不屈の", rank: 3, group: "defense", stats: ["vit", "maxHp", "defenseEfficiency", "damageReduction", "hpRegen"] },
            { name: "天運の", rank: 3, group: "treasure", stats: ["luck", "rareFind", "affixFind", "goldBoost", "expBoost"] }
        ];

        const SuffixAffixes = [
            { name: "の一撃", rank: 1, group: "attack", stats: ["dex", "attackFlat", "accuracy", "critRate", "mPen"] },
            { name: "の守り", rank: 1, group: "defense", stats: ["vit", "defenseFlat", "maxHp", "evasionRate", "damageReduction"] },
            { name: "の収集", rank: 1, group: "treasure", stats: ["luck", "goldBoost", "expBoost", "affixFind", "rareFind"] },
            { name: "の猛進", rank: 2, group: "attack", stats: ["str", "attackFlat", "critRate", "damageBoost", "accuracy"] },
            { name: "の護り", rank: 2, group: "defense", stats: ["vit", "defenseEfficiency", "maxHp", "damageReduction", "hpRegen"] },
            { name: "の財運", rank: 2, group: "treasure", stats: ["luck", "rareFind", "affixFind", "goldBoost", "expBoost"] },
            { name: "の破壊", rank: 3, group: "attack", stats: ["str", "attackEfficiency", "critRate", "critDamage", "damageBoost"] },
            { name: "の堅牢", rank: 3, group: "defense", stats: ["vit", "maxHp", "defenseEfficiency", "damageReduction", "evasionRate"] },
            { name: "の至宝", rank: 3, group: "treasure", stats: ["luck", "rareFind", "affixFind", "goldBoost", "expBoost"] }
        ];

        const AffixValueTable = {
            str: [3, 6, 10],
            vit: [3, 6, 10],
            int: [3, 6, 10],
            dex: [3, 6, 10],
            maxHp: [20, 45, 80],
            maxMp: [15, 35, 70],
            maxHpFlat: [20, 45, 80],
            maxMpFlat: [15, 35, 70],
            hpEfficiency: [3, 6, 10],
            mpEfficiency: [3, 6, 10],
            attackFlat: [6, 12, 22],
            defenseFlat: [6, 12, 22],
            attackEfficiency: [3, 6, 10],
            defenseEfficiency: [3, 6, 10],
            hpRegen: [2, 4, 7],
            mpRegen: [1, 2, 4],
            critRate: [2, 4, 7],
            critDamage: [10, 20, 35],
            damageBoost: [3, 6, 10],
            damageReduction: [2, 4, 7],
            evasionRate: [2, 4, 7],
            leechRate: [2, 4, 6],
            expBoost: [4, 8, 15],
            mPen: [3, 6, 10],
            luck: [5, 10, 18],
            accuracy: [2, 4, 7],
            rareFind: [4, 8, 15],
            affixFind: [5, 10, 18],
            goldBoost: [5, 10, 18]
        };

        const pickRandom = (list) => list[Math.floor(Math.random() * list.length)];

        const getTierIndex = (floor) => {
            const idx = Math.floor((floor - 1) / 50);
            return Math.min(EquipmentTiers.length - 1, Math.max(0, idx));
        };

        const rollRarity = (rareFind) => {
            const weights = [
                { key: "normal", weight: 60 },
                { key: "magic", weight: 25 },
                { key: "rare", weight: 10 },
                { key: "epic", weight: 4 },
                { key: "legendary", weight: 1 }
            ];
            const bonus = Math.max(0, rareFind) / 100;
            const adjusted = weights.map((rarity, idx) => ({
                key: rarity.key,
                weight: rarity.weight * (1 + bonus * idx)
            }));
            const total = adjusted.reduce((sum, r) => sum + r.weight, 0);
            let roll = Math.random() * total;
            let selected = adjusted[0];
            for (const rarity of adjusted) {
                if (roll < rarity.weight) {
                    selected = rarity;
                    break;
                }
                roll -= rarity.weight;
            }
            return RarityDefs.find((rarity) => rarity.key === selected.key);
        };

        const rollAffixRank = (affixRate) => {
            const bonus = Math.min(0.3, Math.max(0, affixRate) / 200);
            const rank1 = Math.max(0.65 - bonus, 0.3);
            const rank3 = Math.min(0.1 + bonus, 0.4);
            const rank2 = 1 - rank1 - rank3;
            const roll = Math.random();
            if (roll < rank1) return 1;
            if (roll < rank1 + rank2) return 2;
            return 3;
        };

        const getAffixStats = (affix, rank) => {
            const pool = affix.stats;
            const stats = [];
            const keys = [...pool];
            for (let i = 0; i < rank; i++) {
                if (keys.length === 0) break;
                const idx = Math.floor(Math.random() * keys.length);
                const key = keys.splice(idx, 1)[0];
                const baseValues = AffixValueTable[key] || [1, 2, 3];
                stats.push({ key, value: baseValues[rank - 1] });
            }
            return stats;
        };

        const rollAffix = (pool, rank) => {
            const candidates = pool.filter((affix) => affix.rank === rank);
            const affix = pickRandom(candidates);
            const stats = getAffixStats(affix, rank);
            return { name: affix.name, rank, stats };
        };

        const buildItem = (base, type) => {
            const totals = getTotalStats();
            const rarity = rollRarity(totals.rareFind);
            const affixChance = Math.min(100, 2 + totals.affixFind);
            const prefixRank = Math.random() * 100 < affixChance ? rollAffixRank(totals.affixFind) : 0;
            const suffixRank = Math.random() * 100 < affixChance ? rollAffixRank(totals.affixFind) : 0;
            const prefix = prefixRank ? rollAffix(PrefixAffixes, prefixRank) : null;
            const suffix = suffixRank ? rollAffix(SuffixAffixes, suffixRank) : null;
            const prefixStars = prefix ? "☆".repeat(prefix.rank) : "";
            const suffixStars = suffix ? "☆".repeat(suffix.rank) : "";
            const baseStats = base.stats.map((stat) => ({
                key: stat.key,
                value: Math.max(1, Math.floor(stat.value * rarity.mul))
            }));
            const affixStats = [
                ...(prefix ? prefix.stats.map((stat) => ({ ...stat, source: "prefix" })) : []),
                ...(suffix ? suffix.stats.map((stat) => ({ ...stat, source: "suffix" })) : [])
            ];
            return {
                name: `${prefixStars}${prefix ? prefix.name : ""}${base.name}${suffix ? suffix.name : ""}${suffixStars}`,
                type,
                rarity: rarity.key,
                rarityMul: rarity.mul,
                baseStats,
                affixStats,
                uniqueStats: [],
                prefix,
                suffix
            };
        };

        const getItemStats = (item) => {
            if (!item) return [];
            return [...(item.baseStats || []), ...(item.affixStats || []), ...(item.uniqueStats || [])];
        };

        const sumStats = (stats) => {
            return stats.reduce((acc, stat) => {
                acc[stat.key] = (acc[stat.key] || 0) + stat.value;
                return acc;
            }, {});
        };

        const getItemStatValue = (item, key) => {
            return getItemStats(item).filter((stat) => stat.key === key).reduce((sum, stat) => sum + stat.value, 0);
        };

        const getSellPrice = (item) => {
            if (!item) return 0;
            const base = SellBasePrices[item.rarity] ?? 0;
            const prefixMul = AffixRankMultipliers[item.prefix?.rank] ?? 1;
            const suffixMul = AffixRankMultipliers[item.suffix?.rank] ?? 1;
            return Math.floor(base * prefixMul * suffixMul);
        };

        const getEquipmentStats = () => {
            const weaponStats = getItemStats(Game.player.weapon);
            const armorStats = getItemStats(Game.player.armor);
            const headStats = getItemStats(Game.player.head);
            const handsStats = getItemStats(Game.player.hands);
            const feetStats = getItemStats(Game.player.feet);
            const accessory1Stats = getItemStats(Game.player.accessory1);
            const accessory2Stats = getItemStats(Game.player.accessory2);
            return sumStats([
                ...weaponStats,
                ...armorStats,
                ...headStats,
                ...handsStats,
                ...feetStats,
                ...accessory1Stats,
                ...accessory2Stats
            ]);
        };

        const getTotalStats = () => {
            const equip = getEquipmentStats();
            return {
                str: Game.player.str + (equip.str || 0),
                vit: Game.player.vit + (equip.vit || 0),
                int: Game.player.int + (equip.int || 0),
                dex: Game.player.dex + (equip.dex || 0),
                maxHp: Game.player.maxHp + (equip.maxHp || 0),
                maxMp: Game.player.maxMp + (equip.maxMp || 0),
                maxHpFlat: Game.player.maxHpFlat + (equip.maxHpFlat || 0),
                maxMpFlat: Game.player.maxMpFlat + (equip.maxMpFlat || 0),
                hpEfficiency: Game.player.hpEfficiency + (equip.hpEfficiency || 0),
                mpEfficiency: Game.player.mpEfficiency + (equip.mpEfficiency || 0),
                attackFlat: Game.player.attackFlat + (equip.attackFlat || 0),
                attackEfficiency: Game.player.attackEfficiency + (equip.attackEfficiency || 0),
                defenseFlat: Game.player.defenseFlat + (equip.defenseFlat || 0),
                defenseEfficiency: Game.player.defenseEfficiency + (equip.defenseEfficiency || 0),
                hpRegen: Game.player.hpRegen + (equip.hpRegen || 0),
                mpRegen: Game.player.mpRegen + (equip.mpRegen || 0),
                goldBoost: Game.player.goldBoost + (equip.goldBoost || 0),
                critRate: Game.player.critRate + (equip.critRate || 0),
                evasionRate: Game.player.evasionRate + (equip.evasionRate || 0),
                leechRate: Game.player.leechRate + (equip.leechRate || 0),
                expBoost: Game.player.expBoost + (equip.expBoost || 0),
                mPen: Game.player.mPen + (equip.mPen || 0),
                luck: Game.player.luck + (equip.luck || 0),
                accuracy: Game.player.accuracy + (equip.accuracy || 0),
                critDamage: Game.player.critDamage + (equip.critDamage || 0),
                damageBoost: Game.player.damageBoost + (equip.damageBoost || 0),
                damageReduction: Game.player.damageReduction + (equip.damageReduction || 0),
                rareFind: Game.player.rareFind + (equip.rareFind || 0),
                affixFind: Game.player.affixFind + (equip.affixFind || 0)
            };
        };

        function getStatusEffect(target, effectId) {
            if (!target || !Array.isArray(target.statusEffects)) return null;
            return target.statusEffects.find(effect => effect.id === effectId) || null;
        }

        function removeStatusEffect(target, effectId) {
            if (!target || !Array.isArray(target.statusEffects)) return;
            target.statusEffects = target.statusEffects.filter(effect => effect.id !== effectId);
        }

        function getStatusModifiers(target) {
            const effects = Array.isArray(target?.statusEffects) ? target.statusEffects : [];
            const mods = {
                atkMul: 1,
                defMul: 1,
                accuracyMul: 1,
                critMul: 1,
                evasionMul: 1,
                damageDoneMul: 1,
                damageTakenMul: 1,
                reflectPct: 0,
                silence: false,
                frozen: false
            };
            effects.forEach(effect => {
                const def = StatusDefs[effect.id];
                if (!def) return;
                const stacks = Math.max(1, effect.stacks || 1);
                if (def.effectType === 'attackUp') {
                    mods.atkMul += 0.1 * stacks;
                }
                if (def.effectType === 'attackDown') {
                    mods.atkMul -= 0.1 * stacks;
                }
                if (def.effectType === 'defenseUp') {
                    mods.defMul += 0.12 * stacks;
                    mods.damageTakenMul *= Math.max(0.2, 1 - 0.08 * stacks);
                }
                if (def.effectType === 'defenseDown') {
                    mods.defMul -= 0.12 * stacks;
                    mods.damageTakenMul *= 1 + 0.08 * stacks;
                }
                if (def.effectType === 'buff') {
                    mods.damageDoneMul *= 1 + 0.1 * stacks;
                }
                if (def.effectType === 'weaken') {
                    mods.damageDoneMul *= Math.max(0.2, 1 - 0.1 * stacks);
                }
                if (def.effectType === 'vulnerable') {
                    mods.damageTakenMul *= 1 + 0.15 * stacks;
                }
                if (def.effectType === 'blind') {
                    mods.accuracyMul *= Math.max(0.2, 1 - 0.15 * stacks);
                    mods.critMul *= Math.max(0.2, 1 - 0.2 * stacks);
                }
                if (def.effectType === 'haste') {
                    mods.accuracyMul *= 1 + 0.08 * stacks;
                    mods.evasionMul *= 1 + 0.1 * stacks;
                }
                if (def.effectType === 'silence') {
                    mods.silence = true;
                }
                if (def.effectType === 'freeze') {
                    mods.frozen = true;
                }
                if (def.effectType === 'reflect') {
                    mods.reflectPct += 0.08 * stacks;
                }
                if (def.effectType === 'taunt') {
                    mods.damageTakenMul *= 1 + 0.05 * stacks;
                    mods.evasionMul *= Math.max(0.2, 1 - 0.05 * stacks);
                }
            });
            mods.atkMul = Math.max(0.1, mods.atkMul);
            mods.defMul = Math.max(0.1, mods.defMul);
            mods.accuracyMul = Math.max(0.2, mods.accuracyMul);
            mods.critMul = Math.max(0.2, mods.critMul);
            mods.evasionMul = Math.max(0.2, mods.evasionMul);
            mods.damageDoneMul = Math.max(0.2, mods.damageDoneMul);
            mods.damageTakenMul = Math.max(0.2, mods.damageTakenMul);
            mods.reflectPct = Math.min(0.6, mods.reflectPct);
            return mods;
        }

        const renderStatLines = (stats) => {
            return stats.map((stat) => {
                const suffix = PercentStats.has(stat.key) ? "%" : "";
                return `${StatLabels[stat.key] || stat.key} +${stat.value}${suffix}`;
            });
        };

        const renderItemStatsHtml = (item) => {
            const stats = renderStatLines(getItemStats(item));
            return stats.map((line) => `<div class="text-[10px] text-slate-400 font-bold">${line}</div>`).join('');
        };

        // --- CORE LOGIC ---
        window.onload = () => {
            spawn();
            updateUI();
            switchJob('warrior');
            switchSkillType('active');
        };

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            document.getElementById(`nav-${p}`).classList.add('active');
            if (p === 'skill') document.getElementById('nav-sp-dot').classList.add('hidden');
        }

        function switchJob(job) {
            Game.currentJobTab = job;
            const selector = document.getElementById('job-select');
            if (selector && selector.value !== job) {
                selector.value = job;
            }
            renderSkillList();
        }

        function getSkillLevel(job, type, idx) {
            return Game.player.skills[job]?.[type]?.[idx] || 0;
        }

        function getPassiveLevel(job, idx) {
            return Game.player.skills[job]?.passive?.[idx] || 0;
        }

        function buildActiveSkill(job, idx, level) {
            const base = JobData[job].active[idx];
            const lv = Math.max(1, level);
            const scale = lv - 1;
            const skill = { ...base, level: lv, maxLevel: base.maxLevel || 5 };
            if (base.mp !== undefined) skill.mp = Math.max(0, Math.round(base.mp + (base.mpGrowth || 0) * scale));
            if (base.pow !== undefined) skill.pow = Math.max(0, base.pow + (base.powGrowth || 0) * scale);
            if (base.val !== undefined) skill.val = Math.max(0, Math.round(base.val + (base.valGrowth || 0) * scale));
            if (base.hits !== undefined) skill.hits = Math.max(1, Math.round(base.hits + (base.hitsGrowth || 0) * scale));
            if (base.mpHeal !== undefined) skill.mpHeal = Math.max(0, base.mpHeal + (base.mpHealGrowth || 0) * scale);
            if (base.expBonus !== undefined) skill.expBonus = Math.max(0, Math.round(base.expBonus + (base.expBonusGrowth || 0) * scale));
            if (base.accuracyBonus !== undefined) skill.accuracyBonus = Math.round(base.accuracyBonus + (base.accuracyGrowth || 0) * scale);
            if (base.critBonus !== undefined) skill.critBonus = Math.round(base.critBonus + (base.critGrowth || 0) * scale);
            if (base.leech !== undefined) skill.leech = Math.max(0, base.leech + (base.leechGrowth || 0) * scale);
            return skill;
        }

        function getSlotSkill(slot) {
            if (!slot) return null;
            const level = getSkillLevel(slot.job, 'active', slot.idx);
            if (level <= 0) return null;
            return buildActiveSkill(slot.job, slot.idx, level);
        }

        function getNextSlotSkill() {
            const slots = Game.player.skillSlots;
            const start = Game.player.skillSlotIndex ?? 0;
            const totalSlots = slots.length;
            const findNextIndex = (currentIndex) => {
                for (let i = 1; i <= totalSlots; i++) {
                    const idx = (currentIndex + i) % totalSlots;
                    if (getSlotSkill(slots[idx])) return idx;
                }
                return currentIndex;
            };
            for (let i = 0; i < totalSlots; i++) {
                const idx = (start + i) % totalSlots;
                const skill = getSlotSkill(slots[idx]);
                if (skill) {
                    return { skill, slotIndex: idx, nextIndex: findNextIndex(idx) };
                }
            }
            return { skill: null, slotIndex: start, nextIndex: start };
        }

        function setSkillSlotTarget(idx) {
            Game.player.skillSlotTarget = idx;
            renderSkillList();
            updateUI();
        }

        function assignSkillToSlot(job, idx) {
            const level = getSkillLevel(job, 'active', idx);
            if (level <= 0) return;
            Game.player.skillSlots[Game.player.skillSlotTarget] = { job, idx };
            updateUI();
        }

        function clearSkillSlot(idx) {
            Game.player.skillSlots[idx] = null;
            updateUI();
        }

        function getDerivedStats() {
            const p = Game.player;
            const totals = getTotalStats();
            const statusMods = getStatusModifiers(p);
            const maxHpBase = totals.maxHp + totals.maxHpFlat;
            const maxMpBase = totals.maxMp + totals.maxMpFlat;
            const maxHp = Math.max(1, Math.floor(maxHpBase * (1 + totals.hpEfficiency / 100)));
            const maxMp = Math.max(0, Math.floor(maxMpBase * (1 + totals.mpEfficiency / 100)));
            const atkBase = totals.str + totals.attackFlat;
            const atk = Math.max(0, Math.floor(atkBase * (1 + totals.attackEfficiency / 100) * statusMods.atkMul));
            const defBase = totals.vit + totals.defenseFlat;
            const def = Math.max(0, Math.floor(defBase * (1 + totals.defenseEfficiency / 100) * statusMods.defMul));
            const modifiedTotals = {
                ...totals,
                accuracy: Math.max(0, Math.floor(totals.accuracy * statusMods.accuracyMul)),
                critRate: Math.max(0, Math.floor(totals.critRate * statusMods.critMul)),
                evasionRate: Math.max(0, Math.floor(totals.evasionRate * statusMods.evasionMul))
            };
            return { maxHp, maxMp, atk, def, totals: modifiedTotals };
        }

        function applyDamage(target, amount, source = null, options = {}) {
            const safeAmount = Math.max(0, Math.floor(amount));
            if (!target || safeAmount <= 0) return 0;
            let remaining = safeAmount;
            const barrierEffect = getStatusEffect(target, 'barrier');
            if (barrierEffect) {
                const def = StatusDefs.barrier;
                if (barrierEffect.shield === undefined) {
                    barrierEffect.shield = (def.shieldPerStack || 0) * (barrierEffect.stacks || 1);
                }
                const absorbed = Math.min(remaining, barrierEffect.shield);
                barrierEffect.shield -= absorbed;
                remaining -= absorbed;
                if (barrierEffect.shield <= 0) {
                    removeStatusEffect(target, 'barrier');
                } else if (def.shieldPerStack) {
                    barrierEffect.stacks = Math.max(1, Math.ceil(barrierEffect.shield / def.shieldPerStack));
                }
            }
            if (remaining > 0) {
                target.hp = Math.max(0, target.hp - remaining);
                removeStatusEffect(target, 'freeze');
            }
            if (!options.ignoreReflect && remaining > 0 && source) {
                const mods = getStatusModifiers(target);
                if (mods.reflectPct > 0) {
                    const reflectDamage = Math.max(1, Math.floor(remaining * mods.reflectPct));
                    applyDamage(source, reflectDamage, null, { ignoreReflect: true });
                    addLog(`反射ダメージ ${reflectDamage}`, "text-purple-400");
                }
            }
            return remaining;
        }

        function applyAutoRegen() {
            const p = Game.player;
            const derived = getDerivedStats();
            if (derived.totals.hpRegen > 0) {
                p.hp = Math.min(derived.maxHp, p.hp + derived.totals.hpRegen);
            }
            if (derived.totals.mpRegen > 0) {
                p.mp = Math.min(derived.maxMp, p.mp + derived.totals.mpRegen);
            }
        }

        function advanceStatusEffects(target, phase) {
            if (!target || !Array.isArray(target.statusEffects)) return;
            target.statusEffects = target.statusEffects.filter(effect => effect.turns > 0);
            if (phase === 'start') {
                const isPlayer = target === Game.player;
                const derived = isPlayer ? getDerivedStats() : null;
                const maxHp = isPlayer ? derived.maxHp : target.maxHp;
                const strValue = isPlayer ? derived.totals.str : (target.str || 0);
                target.statusEffects.forEach(effect => {
                    const def = StatusDefs[effect.id];
                    if (!def) return;
                    if (def.effectType === 'poison') {
                        const stacks = Math.max(1, effect.stacks || 1);
                        const baseHp = maxHp || target.hp || 0;
                        const dmg = Math.max(1, Math.floor(baseHp * 0.03 * stacks));
                        applyDamage(target, dmg, null, { ignoreReflect: true });
                    }
                    if (def.effectType === 'bleed') {
                        const stacks = Math.max(1, effect.stacks || 1);
                        const dmg = Math.max(1, Math.floor((2 + strValue * 0.3) * stacks));
                        applyDamage(target, dmg, null, { ignoreReflect: true });
                    }
                });
            }
            if (phase === 'end') {
                target.statusEffects.forEach(effect => {
                    effect.turns -= 1;
                });
                target.statusEffects = target.statusEffects.filter(effect => effect.turns > 0);
            }
        }

        function applyStatusEffect(target, effectId, stacks = 1, turns = null) {
            const def = StatusDefs[effectId];
            if (!def) return;
            if (!Array.isArray(target.statusEffects)) {
                target.statusEffects = [];
            }
            const duration = turns ?? def.defaultTurns ?? 1;
            const maxStacks = def.maxStacks ?? stacks;
            const existing = target.statusEffects.find(effect => effect.id === effectId);
            if (existing) {
                if (def.stackable) {
                    existing.stacks = Math.min(maxStacks, existing.stacks + stacks);
                } else {
                    existing.stacks = 1;
                }
                existing.turns = Math.max(existing.turns, duration);
                if (def.effectType === 'barrier') {
                    const perStack = def.shieldPerStack || 0;
                    existing.shield = (existing.shield || 0) + perStack * stacks;
                    const maxShield = perStack * (existing.stacks || 1);
                    if (maxShield > 0) {
                        existing.shield = Math.min(maxShield, existing.shield);
                    }
                }
            } else {
                const entry = {
                    id: effectId,
                    stacks: def.stackable ? Math.min(maxStacks, stacks) : 1,
                    turns: duration
                };
                if (def.effectType === 'barrier') {
                    const perStack = def.shieldPerStack || 0;
                    entry.shield = perStack * entry.stacks;
                }
                target.statusEffects.push(entry);
            }
        }

        const infoModal = document.getElementById('status-info-modal');
        const openInfoModal = () => {
            infoModal.classList.remove('hidden');
            infoModal.classList.add('flex');
        };
        const closeInfoModal = () => {
            infoModal.classList.add('hidden');
            infoModal.classList.remove('flex');
        };
        document.getElementById('secondary-info-btn').addEventListener('click', openInfoModal);
        document.getElementById('status-info-close').addEventListener('click', closeInfoModal);
        document.getElementById('status-info-close-bottom').addEventListener('click', closeInfoModal);
        infoModal.addEventListener('click', (event) => {
            if (event.target === infoModal) closeInfoModal();
        });

        const statusEffectModal = document.getElementById('status-effect-modal');
        const statusEffectTitle = document.getElementById('status-effect-title');
        const statusEffectDesc = document.getElementById('status-effect-desc');
        const statusEffectStacks = document.getElementById('status-effect-stacks');
        const statusEffectTurns = document.getElementById('status-effect-turns');
        const openStatusEffectModal = (def, effect) => {
            if (!def || !effect) return;
            statusEffectTitle.innerHTML = `<i class="fa-solid ${def.icon} text-slate-500"></i> ${def.name}`;
            statusEffectDesc.textContent = def.desc || '効果説明がありません。';
            statusEffectStacks.textContent = `スタック: ${effect.stacks || 1}`;
            statusEffectTurns.textContent = `残りターン: ${effect.turns}`;
            statusEffectModal.classList.remove('hidden');
            statusEffectModal.classList.add('flex');
        };
        const closeStatusEffectModal = () => {
            statusEffectModal.classList.add('hidden');
            statusEffectModal.classList.remove('flex');
        };
        document.getElementById('status-effect-close').addEventListener('click', closeStatusEffectModal);
        document.getElementById('status-effect-close-bottom').addEventListener('click', closeStatusEffectModal);
        statusEffectModal.addEventListener('click', (event) => {
            if (event.target === statusEffectModal) closeStatusEffectModal();
        });

        const lootFilterModal = document.getElementById('loot-filter-modal');
        const lootFilterOpenBtn = document.getElementById('loot-filter-open');
        const lootFilterCloseBtn = document.getElementById('loot-filter-close');
        const lootFilterCloseBottomBtn = document.getElementById('loot-filter-close-bottom');
        const lootFilterCheckboxes = Array.from(document.querySelectorAll('.loot-filter-checkbox'));

        const syncLootFilterUI = () => {
            lootFilterCheckboxes.forEach((checkbox) => {
                const rarity = checkbox.dataset.rarity;
                checkbox.checked = Boolean(Game.lootFilter?.[rarity]);
            });
        };

        const openLootFilterModal = () => {
            syncLootFilterUI();
            lootFilterModal.classList.remove('hidden');
            lootFilterModal.classList.add('flex');
        };

        const closeLootFilterModal = () => {
            lootFilterModal.classList.add('hidden');
            lootFilterModal.classList.remove('flex');
        };

        lootFilterOpenBtn.addEventListener('click', openLootFilterModal);
        lootFilterCloseBtn.addEventListener('click', closeLootFilterModal);
        lootFilterCloseBottomBtn.addEventListener('click', closeLootFilterModal);
        lootFilterModal.addEventListener('click', (event) => {
            if (event.target === lootFilterModal) closeLootFilterModal();
        });
        lootFilterCheckboxes.forEach((checkbox) => {
            checkbox.addEventListener('change', (event) => {
                const rarity = event.target.dataset.rarity;
                Game.lootFilter[rarity] = event.target.checked;
            });
        });

        function switchSkillType(type) {
            Game.currentSkillType = type;
            document.querySelectorAll('.type-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${type}`).classList.add('active');
            renderSkillList();
        }

        function renderSkillList() {
            const list = document.getElementById('skill-list');
            list.innerHTML = '';
            const data = JobData[Game.currentJobTab][Game.currentSkillType];
            
            data.forEach((skill, idx) => {
                const level = getSkillLevel(Game.currentJobTab, Game.currentSkillType, idx);
                const maxLevel = skill.maxLevel || 5;
                const isLearned = level > 0;
                const isMax = level >= maxLevel;
                const card = document.createElement('div');
                card.className = `p-4 rounded-2xl border-2 transition-all shadow-sm ${isLearned ? 'bg-white border-slate-800' : 'bg-slate-100 border-slate-200 opacity-60'}`;
                
                let actionPart = '';
                if (!isLearned) {
                    actionPart = `<button onclick="learnSkill('${Game.currentJobTab}', '${Game.currentSkillType}', ${idx})" class="shrink-0 px-4 py-2 bg-slate-800 text-white text-[10px] font-black rounded-xl">1SP習得</button>`;
                } else if (!isMax) {
                    actionPart = `<button onclick="learnSkill('${Game.currentJobTab}', '${Game.currentSkillType}', ${idx})" class="shrink-0 px-4 py-2 bg-amber-500 text-white text-[10px] font-black rounded-xl">1SP強化</button>`;
                } else {
                    actionPart = `<span class="shrink-0 text-xs font-black text-slate-400"><i class="fas fa-check-circle"></i></span>`;
                }

                if (Game.currentSkillType === 'active' && isLearned) {
                    const targetSlot = Game.player.skillSlotTarget + 1;
                    actionPart = `
                        <div class="flex items-center gap-2">
                            ${actionPart}
                            <button onclick="assignSkillToSlot('${Game.currentJobTab}', ${idx})" class="shrink-0 px-3 py-2 bg-blue-600 text-white text-[10px] font-black rounded-xl">S${targetSlot}セット</button>
                        </div>
                    `;
                }

                const displaySkill = (Game.currentSkillType === 'active')
                    ? buildActiveSkill(Game.currentJobTab, idx, Math.max(1, level || 1))
                    : skill;

                card.innerHTML = `
                    <div class="flex justify-between items-center gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-0.5">
                                <span class="font-black text-sm truncate">${displaySkill.name}</span>
                                ${displaySkill.mp !== undefined ? `<span class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded-full font-bold">MP ${displaySkill.mp}</span>` : ''}
                                <span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded-full font-bold">Lv ${level}/${maxLevel}</span>
                            </div>
                            <p class="text-[10px] text-slate-500 leading-tight">${displaySkill.desc}</p>
                        </div>
                        ${actionPart}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function learnSkill(job, type, idx) {
            const skill = JobData[job][type][idx];
            const current = getSkillLevel(job, type, idx);
            const maxLevel = skill.maxLevel || 5;
            if (Game.player.sp <= 0 || current >= maxLevel) return;
            Game.player.sp--;
            Game.player.skills[job][type][idx] = current + 1;
            
            if (type === 'passive' && skill.apply) {
                skill.apply(1);
            }

            renderSkillList();
            updateUI();
        }

        function spawn() {
            const scale = 1 + (Game.floor * 0.22);
            const baseIdx = Math.min(EnemyBases.length - 1, Math.floor(Game.floor / 5));
            const base = EnemyBases[baseIdx];
            Game.enemy = { 
                ...base, 
                maxHp: Math.floor(base.hp * scale), 
                hp: Math.floor(base.hp * scale), 
                str: Math.floor(base.str * scale),
                statusEffects: []
            };
            Game.state = 'combat';
        }

        document.getElementById('action-btn').onclick = () => {
            if (Game.state === 'dead') return;
            if (Game.state === 'idle') {
                Game.floor++;
                spawn();
                addLog(`B${Game.floor}へ潜入...`);
                updateUI();
                return;
            }

            advanceStatusEffects(Game.player, 'start');
            if (Game.player.hp <= 0) {
                die();
                updateUI();
                return;
            }
            const playerStatusMods = getStatusModifiers(Game.player);
            if (playerStatusMods.frozen) {
                addLog("凍結で行動不能！", "text-sky-400");
                advanceStatusEffects(Game.player, 'end');
                applyAutoRegen();
                setTimeout(enemyTurn, 300);
                updateUI();
                return;
            }

            const slotResult = getNextSlotSkill();
            let currentSkill = { name: '通常攻撃', mp: 0, pow: 1.0 };
            let isMagic = false;
            
            if (slotResult.skill) {
                currentSkill = slotResult.skill;
                if (currentSkill.isMagic) isMagic = true;
            }

            if (Game.player.mp < currentSkill.mp) {
                addLog("MP不足！通常攻撃", "text-blue-400");
                currentSkill = { name: '通常攻撃', mp: 0, pow: 1.0 };
                isMagic = false;
            }
            if (playerStatusMods.silence && currentSkill.name !== '通常攻撃') {
                addLog("沈黙でスキル不可！通常攻撃に変更", "text-slate-400");
                currentSkill = { name: '通常攻撃', mp: 0, pow: 1.0 };
                isMagic = false;
            }

            Game.player.skillSlotIndex = slotResult.nextIndex;

            const derived = getDerivedStats();
            const enemyStatusMods = getStatusModifiers(Game.enemy);

            if (currentSkill.hpCost) {
                const cost = Math.floor(derived.maxHp * currentSkill.hpCost);
                Game.player.hp = Math.max(1, Game.player.hp - cost);
            }

            Game.player.mp -= currentSkill.mp;

            if (currentSkill.type === 'heal') {
                const amt = Math.floor(currentSkill.val + (derived.totals.int * 1.2));
                Game.player.hp = Math.min(derived.maxHp, Game.player.hp + amt);
                addLog(`【回復】${amt}HP`, "text-green-500");
                dmgText(amt, true);
            } else {
                let hits = currentSkill.hits || 1;
                let totalDamage = 0;
                let landedHit = false;
                
                for(let i=0; i<hits; i++){
                    let hitChance = Math.min(100, derived.totals.accuracy + (currentSkill.accuracyBonus || 0));
                    if (Math.random() * 100 > hitChance) {
                        continue;
                    }
                    landedHit = true;
                    // Base Attack Power Calculation
                    let atkBase = isMagic ? (derived.totals.int * 2) : derived.atk;
                    
                    // Critical Check
                    let isCrit = Math.random() * 100 < (derived.totals.critRate + (currentSkill.critBonus || 0));
                    let dmg = Math.floor(currentSkill.pow * atkBase * (0.9 + Math.random() * 0.2));
                    if (isCrit) dmg = Math.floor(dmg * (derived.totals.critDamage / 100));

                    // Passive: Low HP boost
                    const lowHpLevel = getPassiveLevel('warrior', 5);
                    if (lowHpLevel > 0 && Game.player.hp < derived.maxHp * 0.3) {
                        dmg = Math.floor(dmg * (1 + 0.1 * lowHpLevel));
                    }
                    // Passive: First hit boost
                    const firstHitLevel = getPassiveLevel('thief', 5);
                    if (firstHitLevel > 0 && Game.enemy.hp === Game.enemy.maxHp) {
                        dmg = Math.floor(dmg * (1 + 0.25 * firstHitLevel));
                    }

                    if (derived.totals.damageBoost > 0) {
                        dmg = Math.floor(dmg * (1 + derived.totals.damageBoost / 100));
                    }
                    dmg = Math.floor(dmg * playerStatusMods.damageDoneMul);
                    dmg = Math.floor(dmg * enemyStatusMods.damageTakenMul);

                    dmg = Math.max(1, dmg);
                    const appliedDamage = applyDamage(Game.enemy, dmg, Game.player);
                    totalDamage += appliedDamage;
                    
                    // Leech
                    const totalLeech = derived.totals.leechRate + (currentSkill.leech || 0);
                    if (totalLeech > 0 && appliedDamage > 0) {
                        let l = Math.floor(appliedDamage * (totalLeech / 100));
                        if (l > 0) {
                            Game.player.hp = Math.min(derived.maxHp, Game.player.hp + l);
                        }
                    }
                }
                
                if (totalDamage === 0) {
                    if (landedHit) {
                        addLog("バリアに防がれた！", "text-slate-400");
                        dmgText(0, false);
                    } else {
                        addLog("攻撃が外れた！", "text-slate-400");
                        dmgText("MISS", false);
                    }
                } else {
                    addLog(`${currentSkill.name}！ ${totalDamage}のダメージ`);
                    dmgText(totalDamage);
                }

                if (currentSkill.mpHeal && totalDamage > 0) {
                    const mHeal = Math.floor(totalDamage * currentSkill.mpHeal);
                    Game.player.mp = Math.min(derived.maxMp, Game.player.mp + mHeal);
                }
                if (currentSkill.expBonus && totalDamage > 0) {
                    let b = Math.floor(Game.player.next * (currentSkill.expBonus / 100));
                    Game.player.exp += b;
                    addLog(`EXP +${b} 奪取！`);
                }

                document.getElementById('enemy-visual').classList.add('shake');
                setTimeout(()=>document.getElementById('enemy-visual').classList.remove('shake'), 200);
            }

            advanceStatusEffects(Game.player, 'end');
            applyAutoRegen();
            if (Game.enemy.hp <= 0) {
                victory();
            } else {
                setTimeout(enemyTurn, 300);
            }
            updateUI();
        };

        function enemyTurn() {
            if (Game.state !== 'combat') return;

            advanceStatusEffects(Game.enemy, 'start');
            if (Game.enemy.hp <= 0) {
                victory();
                updateUI();
                return;
            }
            const enemyStatusMods = getStatusModifiers(Game.enemy);
            if (enemyStatusMods.frozen) {
                addLog(`${Game.enemy.name}は凍結で動けない！`, "text-sky-400");
                advanceStatusEffects(Game.enemy, 'end');
                applyAutoRegen();
                updateUI();
                return;
            }
            const derived = getDerivedStats();
            const playerStatusMods = getStatusModifiers(Game.player);
            
            // Evasion Check
            if (Math.random() * 100 < derived.totals.evasionRate) {
                addLog("攻撃を回避！", "text-blue-500 font-bold");
                dmgText("MISS", false);
                advanceStatusEffects(Game.enemy, 'end');
                updateUI();
                return;
            }
            let enemyAtk = Game.enemy.str * enemyStatusMods.atkMul;
            let d = Math.floor(enemyAtk * (0.8 + Math.random() * 0.4)) - derived.def;
            // Passive: Armor Boost
            const armorBoostLevel = getPassiveLevel('warrior', 4);
            if (armorBoostLevel > 0) d -= Math.floor(getItemStatValue(Game.player.armor, "defenseFlat") * 0.15 * armorBoostLevel);
            
            if (derived.totals.damageReduction > 0) {
                d = Math.floor(d * (1 - derived.totals.damageReduction / 100));
            }
            d = Math.floor(d * enemyStatusMods.damageDoneMul);
            d = Math.floor(d * playerStatusMods.damageTakenMul);
            d = Math.max(1, d);
            const appliedDamage = applyDamage(Game.player, d, Game.enemy);
            addLog(`${Game.enemy.name}：${appliedDamage}ダメ`, "text-red-400");
            if (Math.random() < 0.2) {
                applyStatusEffect(Game.player, 'poison');
                addLog("毒を受けた！", "text-green-600");
            }
            
            // Passive: MP Regen
            const mpRegenLevel = getPassiveLevel('mage', 2);
            if (mpRegenLevel > 0) {
                Game.player.mp = Math.min(derived.maxMp, Game.player.mp + (2 * mpRegenLevel));
            }
            
            // Passive: Counter
            const counterLevel = getPassiveLevel('warrior', 3);
            if (counterLevel > 0 && Math.random() < (0.03 * counterLevel)) {
                const derived = getDerivedStats();
                let cdmg = Math.floor(derived.totals.str * (0.2 + 0.1 * counterLevel));
                Game.enemy.hp = Math.max(0, Game.enemy.hp - cdmg);
                addLog("カウンター！", "text-orange-500");
                dmgText(cdmg);
                if (Game.enemy.hp <= 0) victory();
            }

            advanceStatusEffects(Game.enemy, 'end');
            applyAutoRegen();
            if (Game.player.hp <= 0) die();
            updateUI();
        }

        function victory() {
            Game.state = 'idle';
            addLog(`討伐成功！`, "text-yellow-500 font-black");
            let gain = Game.enemy.exp;
            // Exp Boost Calculation
            const totals = getTotalStats();
            gain = Math.floor(gain * (1 + totals.expBoost / 100));
            Game.player.exp += gain;

            if (Game.player.exp >= Game.player.next) {
                Game.player.level++;
                Game.player.exp -= Game.player.next;
                Game.player.next = Math.floor(Game.player.next * 1.4);
                Game.player.maxHp += 25; Game.player.hp = Game.player.maxHp;
                Game.player.maxMp += 15; Game.player.mp = Game.player.maxMp;
                Game.player.str += 3; Game.player.vit += 3; Game.player.int += 3; Game.player.dex += 2;
                Game.player.sp += 3;
                addLog(`LEVEL UP! [${Game.player.level}]`, "text-blue-400 font-black");
                document.getElementById('nav-sp-dot').classList.remove('hidden');
            }
            // Drop Luck Check
            let dropChance = Math.min(0.95, getTotalStats().luck / 100);
            if (Math.random() < dropChance) drop();
        }

        function die() {
            Game.state = 'dead';
            const lostExp = Math.floor(Game.player.next * 0.1);
            document.getElementById('lost-exp-val').innerText = lostExp;
            Game.player.exp = Math.max(0, Game.player.exp - lostExp);
            Game.floor = Math.max(1, Game.floor - 20);
            document.getElementById('death-overlay').style.display = 'flex';
        }

        function revive() {
            const derived = getDerivedStats();
            Game.player.hp = derived.maxHp;
            Game.player.mp = derived.maxMp;
            document.getElementById('death-overlay').style.display = 'none';
            document.getElementById('full-log-container').innerHTML = '';
            addLog("命からがら生還した...", "text-slate-400 italic");
            spawn();
            updateUI();
            switchPage('battle');
        }

        function addLog(m, c="") {
            const div = document.createElement('div');
            div.className = c;
            div.innerText = `> ${m}`;
            const full = document.getElementById('full-log-container');
            full.prepend(div);
            if (full.children.length > 50) full.lastChild.remove();
            Game.logs.unshift({m, c});
            if (Game.logs.length > 3) Game.logs.pop();
            for(let i=0; i<3; i++) {
                const el = document.getElementById(`mini-log-${i}`);
                if (Game.logs[i]) {
                    el.innerText = Game.logs[i].m;
                    el.className = Game.logs[i].c || (i===0 ? 'text-slate-800 font-bold' : 'text-slate-400');
                }
            }
        }

        function dmgText(v, isH=false) {
            const el = document.createElement('div');
            el.className = `damage-text ${isH?'text-green-500':'text-red-600'}`;
            el.innerText = v;
            el.style.left = (35 + Math.random()*30) + '%';
            el.style.top = (35 + Math.random()*30) + '%';
            document.getElementById('damage-layer').appendChild(el);
            setTimeout(()=>el.remove(), 800);
        }

        function drop() {
            const tier = EquipmentTiers[getTierIndex(Game.floor)];
            const types = Object.keys(EquipmentTypePools);
            const type = pickRandom(types);
            const poolKey = EquipmentTypePools[type];
            const base = pickRandom(tier[poolKey]);
            Game.tempLoot = buildItem(base, type);
            document.getElementById('loot-display').innerHTML = `
                <div class="text-[10px] text-slate-400 mb-1 uppercase font-black">${EquipmentTypeLabels[Game.tempLoot.type]} Found</div>
                <div class="text-xl font-black rarity-${Game.tempLoot.rarity}">${Game.tempLoot.name}</div>
                <div class="mt-2 space-y-1">${renderItemStatsHtml(Game.tempLoot)}</div>
            `;
            document.getElementById('loot-modal').style.display = 'flex';
            Game.state = 'loot';
        }

        function closeLoot(take) {
            if (take) {
                Game.tempLoot.acquiredAt = Game.inventoryCounter++;
                if (Game.lootFilter?.[Game.tempLoot.rarity]) {
                    Game.player.gold += getSellPrice(Game.tempLoot);
                } else {
                    Game.player.inventory.push(Game.tempLoot);
                }
            } else {
                Game.player.gold += getSellPrice(Game.tempLoot);
            }
            document.getElementById('loot-modal').style.display = 'none';
            Game.state = 'idle';
            updateUI();
        }

        function setInventoryFilter(type) {
            Game.inventoryFilter = type;
            updateUI();
        }

        function toggleInventorySort() {
            const order = ['acquired', 'rarity', 'affix'];
            const current = Game.inventorySort || 'acquired';
            const currentIndex = order.indexOf(current);
            const next = order[(currentIndex + 1) % order.length];
            Game.inventorySort = next;
            updateUI();
        }

        function isItemEquipped(item) {
            return Game.player.weapon === item
                || Game.player.armor === item
                || Game.player.head === item
                || Game.player.hands === item
                || Game.player.feet === item
                || Game.player.accessory1 === item
                || Game.player.accessory2 === item;
        }

        function removeInventoryItem(idx) {
            if (idx < 0 || idx >= Game.player.inventory.length) return false;
            const item = Game.player.inventory[idx];
            if (!item || isItemEquipped(item)) return false;
            Game.player.inventory.splice(idx, 1);
            return true;
        }

        function equip(idx) {
            const item = Game.player.inventory[idx];
            if (!item || isItemEquipped(item)) return;
            if (item.type === 'accessory') {
                let slotKey = 'accessory1';
                if (!Game.player.accessory1) {
                    slotKey = 'accessory1';
                } else if (!Game.player.accessory2) {
                    slotKey = 'accessory2';
                }
                Game.player[slotKey] = item;
                updateUI();
                return;
            }
            Game.player[item.type] = item;
            updateUI();
        }

        function deleteItem(idx) {
            const item = Game.player.inventory[idx];
            if (!item || isItemEquipped(item)) return;
            const price = getSellPrice(item);
            if (removeInventoryItem(idx)) {
                Game.player.gold += price;
            }
            updateUI();
        }

        document.getElementById('rest-btn').onclick = () => {
            if (Game.state !== 'idle') return;
            const derived = getDerivedStats();
            Game.player.hp = derived.maxHp;
            Game.player.mp = derived.maxMp;
            addLog("キャンプで休息。全回復！");
            updateUI();
        };

        function updateUI() {
            const p = Game.player;
            const derived = getDerivedStats();
            const totals = derived.totals;
            document.getElementById('floor-display').innerText = Game.floor;
            document.getElementById('header-lvl').innerText = p.level;
            document.getElementById('header-sp').innerText = p.sp;
            document.getElementById('header-gold').innerText = p.gold;
            document.getElementById('skill-sp-display').innerText = p.sp;

            // Health/Mana/Exp
            p.hp = Math.min(p.hp, derived.maxHp);
            p.mp = Math.min(p.mp, derived.maxMp);
            document.getElementById('player-hp-text').innerText = `${p.hp}/${derived.maxHp}`;
            document.getElementById('player-hp-bar').style.width = (p.hp/derived.maxHp*100)+'%';
            document.getElementById('player-mp-text').innerText = `${p.mp}/${derived.maxMp}`;
            document.getElementById('player-mp-bar').style.width = (p.mp/derived.maxMp*100)+'%';
            document.getElementById('player-exp-text-battle').innerText = `${p.exp}/${p.next}`;
            document.getElementById('player-exp-bar-battle').style.width = (p.exp/p.next*100)+'%';

            const e = Game.enemy;
            if (e) {
                document.getElementById('enemy-name').innerText = e.name;
                document.getElementById('enemy-hp-text').innerText = `${e.hp}/${e.maxHp}`;
                document.getElementById('enemy-hp-bar').style.width = (e.hp/e.maxHp*100)+'%';
                document.getElementById('enemy-visual').innerHTML = `<i class="fas ${e.icon}"></i>`;
            }

            const renderStatusEffects = (target, containerId) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                if (!target || !Array.isArray(target.statusEffects) || target.statusEffects.length === 0) {
                    container.innerHTML = '<span class="text-[10px] text-slate-400"></span>';
                    return;
                }
                target.statusEffects.forEach(effect => {
                    const def = StatusDefs[effect.id];
                    if (!def) return;
                    const badge = document.createElement('button');
                    badge.type = 'button';
                    badge.className = "flex items-center gap-1 bg-slate-100 text-slate-600 px-2 py-1 rounded-full hover:bg-slate-200 transition-colors";
                    badge.innerHTML = `
                        <i class="fa-solid ${def.icon}"></i>
                        <span class="text-[9px] font-bold">x${effect.stacks || 1}</span>
                        <span class="text-[9px]">${effect.turns}T</span>
                    `;
                    badge.addEventListener('click', () => openStatusEffectModal(def, effect));
                    container.appendChild(badge);
                });
            };
            renderStatusEffects(Game.player, 'player-status-effects');
            renderStatusEffects(Game.enemy, 'enemy-status-effects');

            // Skill Slots
            const battleSlots = document.getElementById('battle-skill-slots');
            if (battleSlots) {
                battleSlots.innerHTML = '';
                const slotResult = getNextSlotSkill();
                const nextSkill = slotResult.skill;
                const label = nextSkill ? `${nextSkill.name} MP ${nextSkill.mp}` : '通常攻撃 MP 0';
                const card = document.createElement('div');
                card.className = "rounded-xl border px-3 py-2 text-center text-[10px] font-bold border-slate-200 bg-slate-50 text-slate-700";
                card.innerHTML = `<div class="truncate">${label}</div>`;
                battleSlots.appendChild(card);
            }

            const slotSettings = document.getElementById('skill-slot-settings');
            if (slotSettings) {
                slotSettings.innerHTML = '';
                Game.player.skillSlots.forEach((slot, idx) => {
                    const skill = getSlotSkill(slot);
                    const wrapper = document.createElement('div');
                    wrapper.className = "flex items-center gap-2";

                    const slotButton = document.createElement('button');
                    slotButton.className = `flex-1 text-left px-2 py-1.5 rounded-lg border text-[10px] font-bold ${
                        Game.player.skillSlotTarget === idx ? 'border-slate-800 bg-slate-800 text-white' : 'border-slate-200 bg-slate-50 text-slate-500'
                    }`;
                    slotButton.innerHTML = `
                        <div class="text-[9px] font-black">S${idx + 1}</div>
                        <div class="truncate">${skill ? skill.name : '未設定'}</div>
                    `;
                    slotButton.addEventListener('click', () => setSkillSlotTarget(idx));

                    const clearButton = document.createElement('button');
                    clearButton.className = `w-8 h-8 rounded-lg border flex items-center justify-center ${
                        skill ? 'border-slate-200 text-slate-500 bg-white' : 'border-slate-100 text-slate-300 bg-slate-50'
                    }`;
                    clearButton.innerHTML = '<i class="fas fa-xmark"></i>';
                    if (skill) {
                        clearButton.addEventListener('click', () => clearSkillSlot(idx));
                    } else {
                        clearButton.disabled = true;
                    }

                    wrapper.appendChild(slotButton);
                    wrapper.appendChild(clearButton);
                    slotSettings.appendChild(wrapper);
                });
            }

            // Button Control
            const btn = document.getElementById('action-btn');
            if (Game.state === 'combat') {
                btn.innerHTML = `<i class="fas fa-sword"></i> <span>攻撃</span>`;
                btn.className = "w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg flex items-center justify-center gap-2";
            } else {
                btn.innerHTML = `<i class="fas fa-shoe-prints"></i> <span>次の階層へ</span>`;
                btn.className = "w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg flex items-center justify-center gap-2";
            }

            // Status Details
            document.getElementById('status-lvl').innerText = p.level;
            document.getElementById('status-atk').innerText = totals.str;
            document.getElementById('status-def').innerText = totals.vit;
            document.getElementById('status-int').innerText = totals.int;
            document.getElementById('status-dex').innerText = totals.dex;
            document.getElementById('status-exp').innerText = p.exp;
            document.getElementById('status-next').innerText = p.next;
            document.getElementById('status-exp-bar').style.width = (p.exp/p.next*100)+'%';
            
            // Secondary Stats Display
            document.getElementById('stat-max-hp').innerText = totals.maxHpFlat;
            document.getElementById('stat-hp-eff').innerText = totals.hpEfficiency + "%";
            document.getElementById('stat-max-mp').innerText = totals.maxMpFlat;
            document.getElementById('stat-mp-eff').innerText = totals.mpEfficiency + "%";
            document.getElementById('stat-atk-flat').innerText = totals.attackFlat;
            document.getElementById('stat-atk-eff').innerText = totals.attackEfficiency + "%";
            document.getElementById('stat-def-flat').innerText = totals.defenseFlat;
            document.getElementById('stat-def-eff').innerText = totals.defenseEfficiency + "%";
            document.getElementById('stat-crit').innerText = totals.critRate + "%";
            document.getElementById('stat-eva').innerText = totals.evasionRate + "%";
            document.getElementById('stat-leech').innerText = totals.leechRate + "%";
            document.getElementById('stat-exp-boost').innerText = totals.expBoost + "%";
            document.getElementById('stat-m-pen').innerText = totals.mPen + "%";
            document.getElementById('stat-luck').innerText = `${totals.luck}%`;
            document.getElementById('stat-accuracy').innerText = `${totals.accuracy}%`;
            document.getElementById('stat-hp-regen').innerText = totals.hpRegen;
            document.getElementById('stat-mp-regen').innerText = totals.mpRegen;
            document.getElementById('stat-crit-dmg').innerText = `${totals.critDamage}%`;
            document.getElementById('stat-dmg-boost').innerText = `${totals.damageBoost}%`;
            document.getElementById('stat-dmg-reduction').innerText = `${totals.damageReduction}%`;
            document.getElementById('stat-rare-find').innerText = `${totals.rareFind}%`;
            document.getElementById('stat-affix-find').innerText = `${totals.affixFind}%`;
            document.getElementById('stat-gold-boost').innerText = `${totals.goldBoost}%`;

            document.getElementById('equip-weapon').innerText = p.weapon?.name || "なし";
            document.getElementById('equip-weapon').className = `font-bold truncate text-sm rarity-${p.weapon?.rarity||'normal'}`;
            document.getElementById('weapon-val').innerHTML = p.weapon ? renderItemStatsHtml(p.weapon) : "";
            document.getElementById('equip-armor').innerText = p.armor?.name || "なし";
            document.getElementById('equip-armor').className = `font-bold truncate text-sm rarity-${p.armor?.rarity||'normal'}`;
            document.getElementById('armor-val').innerHTML = p.armor ? renderItemStatsHtml(p.armor) : "";
            document.getElementById('equip-head').innerText = p.head?.name || "なし";
            document.getElementById('equip-head').className = `font-bold truncate text-sm rarity-${p.head?.rarity||'normal'}`;
            document.getElementById('head-val').innerHTML = p.head ? renderItemStatsHtml(p.head) : "";
            document.getElementById('equip-hands').innerText = p.hands?.name || "なし";
            document.getElementById('equip-hands').className = `font-bold truncate text-sm rarity-${p.hands?.rarity||'normal'}`;
            document.getElementById('hands-val').innerHTML = p.hands ? renderItemStatsHtml(p.hands) : "";
            document.getElementById('equip-feet').innerText = p.feet?.name || "なし";
            document.getElementById('equip-feet').className = `font-bold truncate text-sm rarity-${p.feet?.rarity||'normal'}`;
            document.getElementById('feet-val').innerHTML = p.feet ? renderItemStatsHtml(p.feet) : "";
            document.getElementById('equip-accessory1').innerText = p.accessory1?.name || "なし";
            document.getElementById('equip-accessory1').className = `font-bold truncate text-sm rarity-${p.accessory1?.rarity||'normal'}`;
            document.getElementById('accessory1-val').innerHTML = p.accessory1 ? renderItemStatsHtml(p.accessory1) : "";
            document.getElementById('equip-accessory2').innerText = p.accessory2?.name || "なし";
            document.getElementById('equip-accessory2').className = `font-bold truncate text-sm rarity-${p.accessory2?.rarity||'normal'}`;
            document.getElementById('accessory2-val').innerHTML = p.accessory2 ? renderItemStatsHtml(p.accessory2) : "";

            // Inventory
            const invList = document.getElementById('inventory-list');
            invList.innerHTML = '';
            document.getElementById('inv-count').innerText = p.inventory.length;
            p.inventory.forEach((item) => {
                if (item.acquiredAt === undefined) {
                    item.acquiredAt = Game.inventoryCounter++;
                }
            });
            const activeFilter = Game.inventoryFilter || 'all';
            const sortMode = Game.inventorySort || 'acquired';
            const filteredItems = p.inventory
                .map((item, index) => ({ item, index }))
                .filter(({ item }) => activeFilter === 'all' || item.type === activeFilter);
            const getAffixScore = (item) => (item.prefix?.rank || 0) + (item.suffix?.rank || 0);
            const sortedItems = [...filteredItems].sort((a, b) => {
                const rarityA = RaritySortOrder[a.item.rarity] ?? 0;
                const rarityB = RaritySortOrder[b.item.rarity] ?? 0;
                const acquiredA = a.item.acquiredAt ?? a.index;
                const acquiredB = b.item.acquiredAt ?? b.index;
                if (sortMode === 'rarity') {
                    if (rarityA !== rarityB) return rarityB - rarityA;
                    return acquiredA - acquiredB;
                }
                if (sortMode === 'affix') {
                    const affixA = getAffixScore(a.item);
                    const affixB = getAffixScore(b.item);
                    if (affixA !== affixB) return affixB - affixA;
                    if (rarityA !== rarityB) return rarityB - rarityA;
                    return acquiredA - acquiredB;
                }
                return acquiredA - acquiredB;
            });
            sortedItems.forEach(({ item, index }) => {
                const sellPrice = getSellPrice(item);
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border flex items-center justify-between shadow-sm";
                const equipped = isItemEquipped(item);
                const equipMarker = equipped
                    ? '<span class="text-emerald-500 font-black mr-1">[E]</span>'
                    : '';
                const deleteLabel = equipped ? '装備中' : '売却';
                const deleteClasses = equipped
                    ? 'bg-slate-100 text-slate-300 cursor-not-allowed'
                    : 'bg-slate-100 text-slate-500';
                div.innerHTML = `
                    <div class="min-w-0 flex-1">
                        <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1">${EquipmentTypeLabels[item.type]}</div>
                        <div class="font-black text-sm truncate rarity-${item.rarity}">${equipMarker}${item.name}</div>
                        <div class="mt-1 space-y-0.5">${renderItemStatsHtml(item)}</div>
                    </div>
                    <div class="ml-4 flex flex-col gap-2">
                        <button onclick="equip(${index})" class="px-5 py-2.5 bg-slate-800 text-white text-[11px] font-black rounded-xl">装備</button>
                        <button onclick="deleteItem(${index})" class="px-5 py-2.5 ${deleteClasses} text-[11px] font-black rounded-xl" ${equipped ? 'disabled' : ''}><i class="fas fa-coins"></i> ${deleteLabel}</button>
                        <div class="text-[10px] text-slate-400 font-bold text-right">売値 ${sellPrice}G</div>
                    </div>
                `;
                invList.appendChild(div);
            });

            document.querySelectorAll('.inv-filter-btn').forEach((button) => {
                const type = button.getAttribute('data-inv-filter');
                const active = type === activeFilter;
                button.className = `inv-filter-btn py-2 rounded-xl border ${
                    active ? 'border-slate-800 bg-slate-800 text-white' : 'border-slate-200 bg-slate-50 text-slate-500'
                }`;
            });

            const sortDef = InventorySortDefs[sortMode] || InventorySortDefs.acquired;
            const sortLabel = document.getElementById('inv-sort-label');
            if (sortLabel) {
                sortLabel.innerText = sortDef.label;
            }
            const sortButton = document.getElementById('inv-sort-toggle');
            if (sortButton) {
                const icon = sortButton.querySelector('i');
                if (icon) {
                    icon.className = `fas ${sortDef.icon}`;
                }
            }
        }
    </script>
    </div>
</body>
</html>
