<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>White Dungeon - Professional Build System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap');
        
        html, body {
            margin: 0;
            padding: 0;
            touch-action: manipulation;
            overscroll-behavior: none;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page { display: none; height: 100%; min-height: 0; flex-direction: column; overflow-y: auto; }
        .page.active { display: flex; }

        /* Status Bars */
        .bar-container { position: relative; background-color: #e2e8f0; border-radius: 6px; overflow: hidden; height: 20px; border: 1px solid #cbd5e1; width: 100%; }
        .bar-fill { height: 100%; transition: width 0.3s ease; }
        .hp-fill { background-color: #ef4444; }
        .mp-fill { background-color: #3b82f6; }
        .exp-fill { background-color: #fbbf24; }
        .bar-text { position: absolute; inset: 0; display: flex; items-center; justify-content: center; font-size: 10px; font-weight: 800; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.5); pointer-events: none; }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-40px); }
        }
        .damage-text {
            position: absolute;
            font-weight: 900;
            font-size: 1.5rem;
            animation: floatUp 0.8s forwards;
            pointer-events: none;
            z-index: 100;
            text-shadow: 2px 2px 0 #fff;
        }

        .mini-log {
            font-size: 10px;
            line-height: 1.2;
            mask-image: linear-gradient(to top, black 70%, transparent 100%);
        }

        .rarity-common { color: #64748b; }
        .rarity-uncommon { color: #22c55e; font-weight: bold; }
        .rarity-rare { color: #3b82f6; font-weight: bold; }
        .rarity-epic { color: #a855f7; font-weight: bold; }
        .rarity-legendary { color: #f59e0b; font-weight: bold; text-shadow: 0 0 8px rgba(245, 158, 11, 0.3); }

        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        nav button.active { color: #0f172a; border-top: 3px solid #0f172a; background-color: #fff; }
        .job-tab.active { background-color: #0f172a; color: white; }
        .type-tab.active { border-bottom: 3px solid #0f172a; color: #0f172a; font-weight: bold; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="flex flex-col">

    <!-- TOP BAR -->
    <header class="h-12 border-b flex items-center justify-between px-4 shrink-0 bg-white z-50 shadow-sm">
        <div class="font-bold flex items-center gap-2">
            <span class="text-slate-400 text-xs">FLOOR</span>
            <span id="floor-display" class="text-xl font-black">1</span>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-[10px] bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full font-bold">SP: <span id="header-sp">0</span></span>
            <div class="bg-slate-800 text-white text-[10px] px-2 py-1 rounded font-bold">Lv.<span id="header-lvl">1</span></div>
        </div>
    </header>

    <!-- CONTENT PAGES -->
    <main class="flex-1 overflow-hidden relative min-h-0">
        
        <!-- BATTLE PAGE -->
        <section id="page-battle" class="page active p-4">
            <div class="flex-1 flex flex-col items-center justify-center relative min-h-[200px]">
                <div id="enemy-container" class="text-center transition-all duration-300">
                    <div id="enemy-visual" class="text-8xl mb-4 text-slate-700"><i class="fas fa-ghost"></i></div>
                    <div id="enemy-name" class="font-bold text-lg mb-1">ã‚¹ãƒ©ã‚¤ãƒ </div>
                    <div class="w-48 bar-container mx-auto mb-1 h-2 border-0 bg-slate-200">
                        <div id="enemy-hp-bar" class="bar-fill hp-fill"></div>
                    </div>
                    <div class="text-[10px] font-mono text-slate-400">Enemy HP <span id="enemy-hp-text">30/30</span></div>
                </div>
                <div id="damage-layer" class="absolute inset-0 pointer-events-none"></div>
                <div class="absolute right-0 bottom-4 w-1/2 mini-log pointer-events-none text-right pr-2 text-slate-500 italic space-y-1">
                    <div id="mini-log-2"></div>
                    <div id="mini-log-1"></div>
                    <div id="mini-log-0" class="text-slate-800 font-bold"></div>
                </div>
            </div>

            <!-- Player Status Section -->
            <div class="bg-white border rounded-2xl p-4 shadow-sm space-y-3 mb-2">
                <div class="space-y-1.5">
                    <div class="bar-container">
                        <div id="player-hp-bar" class="bar-fill hp-fill"></div>
                        <div class="bar-text">HP: <span id="player-hp-text">100/100</span></div>
                    </div>
                    <div class="bar-container">
                        <div id="player-mp-bar" class="bar-fill mp-fill"></div>
                        <div class="bar-text">MP: <span id="player-mp-text">30/30</span></div>
                    </div>
                    <div class="bar-container">
                        <div id="player-exp-bar-battle" class="bar-fill exp-fill"></div>
                        <div class="bar-text">EXP: <span id="player-exp-text-battle">0/100</span></div>
                    </div>
                </div>

                <div class="space-y-2">
                    <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆ</div>
                    <div id="battle-skill-slots" class="grid grid-cols-4 gap-2"></div>
                </div>
                <button id="action-btn" class="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg flex items-center justify-center gap-2">
                    <i class="fas fa-sword"></i> <span>æ”»æ’ƒ</span>
                </button>
            </div>
            
            <div id="death-overlay" class="absolute inset-0 bg-red-900/40 backdrop-blur-[2px] hidden items-center justify-center z-50">
                <div class="bg-white p-8 rounded-3xl shadow-2xl text-center border-2 border-red-500 mx-4">
                    <div class="text-6xl mb-4">ğŸ’€</div>
                    <h2 class="text-2xl font-black text-red-600 mb-2">YOU DIED</h2>
                    <p class="text-sm text-slate-500 mb-2">ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š</p>
                    <div class="text-xs text-red-600 font-bold mb-6 bg-red-50 p-3 rounded-xl">
                        éšå±¤: -20<br>
                        çµŒé¨“å€¤ãƒ­ã‚¹ãƒˆ: <span id="lost-exp-val">0</span>
                    </div>
                    <button onclick="revive()" class="w-full bg-red-600 text-white font-bold px-8 py-4 rounded-xl shadow-lg active:scale-95">è¡—ã«æˆ»ã‚‹</button>
                </div>
            </div>
        </section>

        <!-- STATUS PAGE -->
        <section id="page-status" class="page p-4 bg-slate-50">
            <h2 class="text-xl font-black mb-4 flex items-center gap-2 px-2"><i class="fas fa-user-circle"></i> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
            
            <!-- Summary Card -->
            <div class="bg-white rounded-3xl p-6 shadow-sm mb-4">
                <div class="flex items-center justify-between border-b pb-4 mb-4">
                    <div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Level</div>
                        <div class="text-4xl font-black" id="status-lvl">1</div>
                    </div>
                    <div class="text-right">
                        <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Experience</div>
                        <div class="text-sm font-bold"><span id="status-exp">0</span> / <span id="status-next">100</span></div>
                        <div class="w-32 bar-container h-2 mt-1 border-0 bg-slate-100"><div id="status-exp-bar" class="bar-fill exp-fill"></div></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-y-6 gap-x-4">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">STR (ç‰©ç†æ”»æ’ƒ)</span>
                        <span class="text-2xl font-black text-slate-700" id="status-atk">10</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">VIT (ç‰©ç†é˜²å¾¡)</span>
                        <span class="text-2xl font-black text-slate-700" id="status-def">5</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">INT (é­”æ³•å¨åŠ›)</span>
                        <span class="text-2xl font-black text-blue-600" id="status-int">5</span>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-[10px] text-slate-400 font-bold uppercase">DEX (å™¨ç”¨ã•)</span>
                        <span class="text-2xl font-black text-green-600" id="status-dex">5</span>
                    </div>
                </div>
            </div>

            <!-- Detailed Stats -->
            <div class="bg-slate-800 rounded-3xl p-6 text-white mb-6">
                <div class="flex items-center justify-between mb-4 border-b border-slate-700 pb-2">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-tighter">Secondary Attributes</h3>
                    <button id="secondary-info-btn" class="text-slate-400 hover:text-white transition-colors text-xs font-bold flex items-center gap-1">
                        <i class="fas fa-circle-info"></i> Info
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>æœ€å¤§HP</span><span id="stat-max-hp">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>HPåŠ¹ç‡</span><span id="stat-hp-eff">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>æœ€å¤§MP</span><span id="stat-max-mp">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>MPåŠ¹ç‡</span><span id="stat-mp-eff">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>HPè‡ªå‹•å›å¾©</span><span id="stat-hp-regen">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>MPè‡ªå‹•å›å¾©</span><span id="stat-mp-regen">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>æ”»æ’ƒåŠ›</span><span id="stat-atk-flat">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>æ”»æ’ƒåŠ¹ç‡</span><span id="stat-atk-eff">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>é˜²å¾¡åŠ›</span><span id="stat-def-flat">0</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>é˜²å¾¡åŠ¹ç‡</span><span id="stat-def-eff">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>å‘½ä¸­ç‡</span><span id="stat-accuracy">95%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ä¼šå¿ƒç‡</span><span id="stat-crit">5%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸</span><span id="stat-crit-dmg">200%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ä¸ãƒ€ãƒ¡å¢—åŠ </span><span id="stat-dmg-boost">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>è¢«ãƒ€ãƒ¡è»½æ¸›</span><span id="stat-dmg-reduction">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>å›é¿ç‡</span><span id="stat-eva">3%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>å¸è¡€ç‡</span><span id="stat-leech">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>é­”æ³•è²«é€š</span><span id="stat-m-pen">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>è¿½åŠ çµŒé¨“å€¤</span><span id="stat-exp-boost">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ãƒ‰ãƒ­ãƒƒãƒ—ç‡</span><span id="stat-luck">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ãƒ¬ã‚¢ãƒ‰ãƒ­ç‡</span><span id="stat-rare-find">0%</span></div>
                    <div class="flex justify-between border-b border-slate-700 pb-1"><span>ã‚´ãƒ¼ãƒ«ãƒ‰å¢—åŠ ç‡</span><span id="stat-gold-boost">0%</span></div>
                </div>
            </div>

            <!-- Equipment -->
            <div class="space-y-3 mb-12">
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-sword"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Weapon Slot</div>
                        <div id="equip-weapon" class="font-bold truncate text-sm">ãªã—</div>
                    </div>
                    <div id="weapon-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <div class="bg-white p-4 rounded-2xl border flex items-center gap-4">
                    <div class="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-shield-halved"></i></div>
                    <div class="flex-1 min-w-0">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">Armor Slot</div>
                        <div id="equip-armor" class="font-bold truncate text-sm">ãªã—</div>
                    </div>
                    <div id="armor-val" class="text-sm font-black text-slate-400"></div>
                </div>
                <button id="rest-btn" class="w-full py-4 bg-green-500 text-white font-black rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 mt-4">
                    <i class="fas fa-bed"></i> ä¼‘æ¯ã—ã¦å…¨å›å¾©ã™ã‚‹
                </button>
            </div>
        </section>

        <!-- SKILL PAGE -->
        <section id="page-skill" class="page bg-slate-50 flex-col h-full min-h-0">
            <div class="p-4 bg-white border-b shrink-0">
                <div class="flex justify-between items-center mb-4 px-1">
                    <h2 class="text-xl font-black">ã‚¹ã‚­ãƒ«ãƒ„ãƒªãƒ¼</h2>
                    <div class="text-sm font-bold bg-amber-100 text-amber-700 px-3 py-1 rounded-full">SP: <span id="skill-sp-display">0</span></div>
                </div>
                <!-- Job Tabs -->
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar">
                    <button onclick="switchJob('warrior')" id="tab-warrior" class="job-tab px-6 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-400 transition-all">æˆ¦å£«</button>
                    <button onclick="switchJob('mage')" id="tab-mage" class="job-tab px-6 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-400 transition-all">é­”è¡“å¸«</button>
                    <button onclick="switchJob('thief')" id="tab-thief" class="job-tab px-6 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-400 transition-all">ç›—è³Š</button>
                    <button onclick="switchJob('ranger')" id="tab-ranger" class="job-tab px-6 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-400 transition-all">ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼</button>
                    <button onclick="switchJob('paladin')" id="tab-paladin" class="job-tab px-6 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-400 transition-all">è–é¨å£«</button>
                    <button onclick="switchJob('monk')" id="tab-monk" class="job-tab px-6 py-2 rounded-full text-xs font-bold bg-slate-100 text-slate-400 transition-all">æ‹³é—˜å£«</button>
                </div>
            </div>
            <div class="flex bg-white shrink-0 shadow-sm">
                <button onclick="switchSkillType('active')" id="tab-active" class="type-tab flex-1 py-3 text-sm text-slate-400 transition-all">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</button>
                <button onclick="switchSkillType('passive')" id="tab-passive" class="type-tab flex-1 py-3 text-sm text-slate-400 transition-all">ãƒ‘ãƒƒã‚·ãƒ–</button>
            </div>
            <div class="p-4 bg-white border-b shrink-0">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-sm font-black">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ­ãƒƒãƒˆ</div>
                    <div class="text-[10px] text-slate-400">ã‚¿ãƒƒãƒ—ã§ã‚¹ãƒ­ãƒƒãƒˆé¸æŠ</div>
                </div>
                <div id="skill-slot-settings" class="grid grid-cols-2 gap-2"></div>
            </div>
            <div id="skill-list" class="flex-1 overflow-y-auto p-4 space-y-3 pb-8 min-h-0"></div>
        </section>

        <!-- INVENTORY PAGE -->
        <section id="page-inventory" class="page p-4 bg-slate-50">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-xl font-black flex items-center gap-2"><i class="fas fa-box-open"></i> æŒã¡ç‰©</h2>
                <span class="text-[10px] font-bold text-slate-400 bg-slate-200 px-2 py-0.5 rounded-full"><span id="inv-count">0</span> / 20</span>
            </div>
            <div id="inventory-list" class="flex-1 overflow-y-auto space-y-2 pb-12"></div>
        </section>

        <!-- LOG PAGE -->
        <section id="page-log" class="page p-4 bg-slate-900 text-slate-300 font-mono text-[10px]">
            <h2 class="text-slate-500 border-b border-slate-800 pb-2 mb-2 uppercase tracking-widest font-black">System History Log</h2>
            <div id="full-log-container" class="flex-1 overflow-y-auto space-y-1"></div>
        </section>

        <!-- HELP PAGE -->
        <section id="page-help" class="page p-4 bg-slate-50">
            <h2 class="text-xl font-black mb-4 flex items-center gap-2 px-2"><i class="fas fa-circle-question"></i> ãƒ˜ãƒ«ãƒ—</h2>
            <div class="bg-white rounded-3xl p-6 shadow-sm space-y-4">
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">çŠ¶æ…‹ç•°å¸¸</div>
                    <p class="text-xs text-slate-500 mt-2">æˆ¦é—˜ã§ç™ºç”Ÿã™ã‚‹çŠ¶æ…‹ç•°å¸¸ã®åŠ¹æœä¸€è¦§ã§ã™ã€‚</p>
                </div>
                <div class="space-y-3 text-sm">
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-skull-crossbones"></i></div>
                        <div>
                            <div class="font-black text-slate-700">æ¯’</div>
                            <div class="text-xs text-slate-500">ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«ã‚¹ã‚¿ãƒƒã‚¯æ•°ã¶ã‚“ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-droplet"></i></div>
                        <div>
                            <div class="font-black text-slate-700">å‡ºè¡€</div>
                            <div class="text-xs text-slate-500">ã‚¿ãƒ¼ãƒ³é–‹å§‹æ™‚ã«ã‚¹ã‚¿ãƒƒã‚¯æ•°ã¶ã‚“ã®ãƒ€ãƒ¡ãƒ¼ã‚¸ã€‚</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-down-long"></i></div>
                        <div>
                            <div class="font-black text-slate-700">å¼±ä½“</div>
                            <div class="text-xs text-slate-500">èƒ½åŠ›ãŒä½ä¸‹ã™ã‚‹çŠ¶æ…‹ã€‚</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-shield-halved"></i></div>
                        <div>
                            <div class="font-black text-slate-700">è„†å¼±</div>
                            <div class="text-xs text-slate-500">è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒå¢—åŠ ã™ã‚‹çŠ¶æ…‹ã€‚</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3">
                        <div class="w-9 h-9 rounded-xl bg-slate-100 flex items-center justify-center text-slate-500"><i class="fas fa-arrow-up-long"></i></div>
                        <div>
                            <div class="font-black text-slate-700">å¼·åŒ–</div>
                            <div class="text-xs text-slate-500">èƒ½åŠ›ãŒä¸Šæ˜‡ã™ã‚‹çŠ¶æ…‹ã€‚</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- BOTTOM NAV -->
    <nav class="h-16 border-t bg-white flex shrink-0 items-center justify-around pb-1 z-50 relative shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <button onclick="switchPage('battle')" id="nav-battle" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-hand-fist text-xl"></i><span class="text-[9px] font-black">æˆ¦é—˜</span>
        </button>
        <button onclick="switchPage('status')" id="nav-status" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-user-circle text-xl"></i><span class="text-[9px] font-black">èƒ½åŠ›</span>
        </button>
        <button onclick="switchPage('skill')" id="nav-skill" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all relative">
            <i class="fas fa-star text-xl"></i><span class="text-[9px] font-black">ã‚¹ã‚­ãƒ«</span>
            <div id="nav-sp-dot" class="absolute top-3 right-6 w-2 h-2 bg-amber-500 rounded-full border-2 border-white hidden"></div>
        </button>
        <button onclick="switchPage('inventory')" id="nav-inventory" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all relative">
            <i class="fas fa-box-open text-xl"></i><span class="text-[9px] font-black">è£…å‚™</span>
            <div id="nav-inv-dot" class="absolute top-3 right-6 w-2 h-2 bg-red-500 rounded-full border-2 border-white hidden"></div>
        </button>
        <button onclick="switchPage('log')" id="nav-log" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-scroll text-xl"></i><span class="text-[9px] font-black">å±¥æ­´</span>
        </button>
        <button onclick="switchPage('help')" id="nav-help" class="flex-1 h-full flex flex-col items-center justify-center gap-1 text-slate-300 transition-all">
            <i class="fas fa-circle-question text-xl"></i><span class="text-[9px] font-black">ãƒ˜ãƒ«ãƒ—</span>
        </button>
    </nav>

    <!-- LOOT MODAL -->
    <div id="loot-modal" class="fixed inset-0 bg-slate-900/80 z-[100] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-[2rem] overflow-hidden shadow-2xl transform scale-100 p-8 text-center border-b-8 border-slate-200">
            <div class="text-6xl mb-6">ğŸ“¦</div>
            <h3 class="font-black text-xl mb-2">æˆ¦åˆ©å“ã‚’ç™ºè¦‹ï¼</h3>
            <div id="loot-display" class="bg-slate-50 rounded-2xl p-6 my-4 border border-slate-100"></div>
            <div class="flex gap-3">
                <button onclick="closeLoot(false)" class="flex-1 py-4 text-sm font-bold text-slate-400 bg-slate-100 rounded-2xl">æ¨ã¦ã‚‹</button>
                <button onclick="closeLoot(true)" class="flex-1 py-4 text-sm font-bold text-white bg-slate-800 rounded-2xl shadow-lg">æ‹¾ã†</button>
            </div>
        </div>
    </div>

    <!-- STATUS INFO MODAL -->
    <div id="status-info-modal" class="fixed inset-0 bg-slate-900/80 z-[110] hidden items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-[2rem] overflow-hidden shadow-2xl p-6 border-b-8 border-slate-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-black text-lg text-slate-800 flex items-center gap-2">
                    <i class="fas fa-circle-info text-slate-500"></i> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒ¢
                </h3>
                <button id="status-info-close" class="text-slate-400 hover:text-slate-700 text-lg"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="space-y-4 text-xs text-slate-600">
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase">Primary</div>
                    <ul class="mt-2 space-y-1">
                        <li><span class="font-bold text-slate-700">STR</span>ï¼šç‰©ç†æ”»æ’ƒã®åŸºç¤å€¤ã€‚æ­¦å™¨ã®ATKã¨åˆç®—ã•ã‚Œã¾ã™ã€‚</li>
                        <li><span class="font-bold text-slate-700">VIT</span>ï¼šè¢«ãƒ€ãƒ¡ãƒ¼ã‚¸è»½æ¸›ã®åŸºç¤å€¤ã€‚é˜²å…·DEFã¨åˆç®—ã•ã‚Œã¾ã™ã€‚</li>
                        <li><span class="font-bold text-slate-700">INT</span>ï¼šé­”æ³•æ”»æ’ƒã®åŸºç¤å€¤ã€‚å›å¾©é‡ã«ã‚‚å½±éŸ¿ã€‚</li>
                        <li><span class="font-bold text-slate-700">DEX</span>ï¼šå™¨ç”¨ã•ã®åŸºç¤å€¤ã€‚è£…å‚™å³é¸ã®ç›®å®‰ã«åˆ©ç”¨ã€‚</li>
                    </ul>
                </div>
                <div>
                    <div class="text-[10px] font-black text-slate-400 uppercase">Secondary</div>
                    <ul class="mt-2 space-y-1">
                        <li>æœ€å¤§HPï¼šHPã‚’å›ºå®šå€¤ã§å¢—åŠ ã€‚</li>
                        <li>HPåŠ¹ç‡ï¼šæœ€å¤§HPã‚’%ã§å¢—åŠ ã€‚</li>
                        <li>æœ€å¤§MPï¼šMPã‚’å›ºå®šå€¤ã§å¢—åŠ ã€‚</li>
                        <li>MPåŠ¹ç‡ï¼šæœ€å¤§MPã‚’%ã§å¢—åŠ ã€‚</li>
                        <li>HPè‡ªå‹•å›å¾©ï¼šã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«HPãŒå›å¾©ã€‚</li>
                        <li>MPè‡ªå‹•å›å¾©ï¼šã‚¿ãƒ¼ãƒ³çµ‚äº†æ™‚ã«MPãŒå›å¾©ã€‚</li>
                        <li>æ”»æ’ƒåŠ›ï¼šç‰©ç†æ”»æ’ƒã®å›ºå®šå¢—åŠ ã€‚</li>
                        <li>æ”»æ’ƒåŠ¹ç‡ï¼šç‰©ç†æ”»æ’ƒã‚’%ã§å¢—åŠ ã€‚</li>
                        <li>é˜²å¾¡åŠ›ï¼šé˜²å¾¡ã®å›ºå®šå¢—åŠ ã€‚</li>
                        <li>é˜²å¾¡åŠ¹ç‡ï¼šé˜²å¾¡ã‚’%ã§å¢—åŠ ã€‚</li>
                        <li>å‘½ä¸­ç‡ï¼šæ”»æ’ƒãŒå‘½ä¸­ã™ã‚‹ç¢ºç‡ã€‚</li>
                        <li>ä¼šå¿ƒç‡ï¼šã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãŒç™ºç”Ÿã™ã‚‹ç¢ºç‡ã€‚</li>
                        <li>ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸ï¼šä¼šå¿ƒæ™‚ã®ãƒ€ãƒ¡ãƒ¼ã‚¸å€ç‡ã€‚</li>
                        <li>ä¸ãƒ€ãƒ¡å¢—åŠ ï¼šé€šå¸¸æ”»æ’ƒãƒ»ã‚¹ã‚­ãƒ«å…¨ä½“ã®ä¸ãƒ€ãƒ¡è£œæ­£ã€‚</li>
                        <li>è¢«ãƒ€ãƒ¡è»½æ¸›ï¼šæ•µæ”»æ’ƒã®æœ€çµ‚ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’è»½æ¸›ã€‚</li>
                        <li>å›é¿ç‡ï¼šæ•µã®æ”»æ’ƒã‚’å›é¿ã™ã‚‹ç¢ºç‡ã€‚</li>
                        <li>å¸è¡€ç‡ï¼šä¸ãˆãŸãƒ€ãƒ¡ãƒ¼ã‚¸ã®ä¸€éƒ¨ã‚’HPå›å¾©ã€‚</li>
                        <li>é­”æ³•è²«é€šï¼šæ•µã®é˜²å¾¡ã‚’ç„¡è¦–ã™ã‚‹å‰²åˆï¼ˆé­”æ³•ç³»ã‚¹ã‚­ãƒ«å‘ã‘ï¼‰ã€‚</li>
                        <li>è¿½åŠ çµŒé¨“å€¤ï¼šç²å¾—çµŒé¨“å€¤ã®å¢—åŠ ç‡ã€‚</li>
                        <li>ãƒ‰ãƒ­ãƒƒãƒ—ç‡ï¼šæˆ¦åˆ©å“ãŒå‡ºã‚‹ç¢ºç‡ã®ä¸Šæ˜‡ã€‚</li>
                        <li>ãƒ¬ã‚¢ãƒ‰ãƒ­ç‡ï¼šãƒ‰ãƒ­ãƒƒãƒ—å“ã®ãƒ¬ã‚¢åº¦ä¸Šæ˜‡ç¢ºç‡ã€‚</li>
                        <li>ã‚´ãƒ¼ãƒ«ãƒ‰å¢—åŠ ç‡ï¼šç²å¾—ã‚´ãƒ¼ãƒ«ãƒ‰ã®å¢—åŠ ç‡ã€‚</li>
                    </ul>
                </div>
            </div>
            <button id="status-info-close-bottom" class="mt-5 w-full bg-slate-800 text-white font-black py-3 rounded-2xl shadow-lg">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (e) {
            const now = Date.now();
            const interactiveTarget = e.target.closest('button, a, input, select, textarea, label');
            if (!interactiveTarget && now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, { passive: false });

        // --- DATA STRUCTURE ---
        const Game = {
            floor: 1,
            state: 'idle',
            player: {
                level: 1,
                hp: 100, maxHp: 100, mp: 30, maxMp: 30,
                // Primary Stats
                str: 10, vit: 5, int: 5, dex: 5,
                // Secondary Stats (calculated)
                maxHpFlat: 0, hpEfficiency: 0, maxMpFlat: 0, mpEfficiency: 0,
                attackFlat: 0, attackEfficiency: 0, defenseFlat: 0, defenseEfficiency: 0,
                hpRegen: 0, mpRegen: 0, goldBoost: 0,
                critRate: 5, evasionRate: 3, leechRate: 0, expBoost: 0, mPen: 0, luck: 0, accuracy: 95,
                critDamage: 200, damageBoost: 0, damageReduction: 0, rareFind: 0,
                exp: 0, next: 100, sp: 0,
                weapon: null, armor: null, inventory: [],
                skillSlots: [null, null, null, null],
                skillSlotIndex: 0,
                skillSlotTarget: 0,
                statusEffects: [],
                skills: {
                    warrior: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    mage: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    thief: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    ranger: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    paladin: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] },
                    monk: { active: [0,0,0,0,0,0], passive: [0,0,0,0,0,0] }
                }
            },
            currentJobTab: 'warrior',
            currentSkillType: 'active',
            enemy: null, logs: []
        };

        const JobKeys = ['warrior', 'mage', 'thief', 'ranger', 'paladin', 'monk'];

        const JobData = {
            warrior: {
                name: "æˆ¦å£«",
                active: [
                    { id: 0, name: "ãƒ‘ãƒ¯ãƒ¼ã‚¹ãƒ©ãƒƒã‚·ãƒ¥", mp: 4, mpGrowth: 0, pow: 1.6, powGrowth: 0.25, maxLevel: 5, desc: "åŠ›ã§å©ãè¾¼ã‚€ä¸€æ’ƒã€‚Lvã§å¨åŠ›ä¸Šæ˜‡" },
                    { id: 1, name: "ã‚·ãƒ¼ãƒ«ãƒ‰ãƒãƒƒã‚·ãƒ¥", mp: 6, mpGrowth: 0, pow: 1.1, powGrowth: 0.2, accuracyBonus: 10, accuracyGrowth: 5, maxLevel: 5, desc: "ç›¾ã§å©ãã€å‘½ä¸­ç‡ãŒé«˜ã„" },
                    { id: 2, name: "ãƒãƒ¼ã‚µã‚¯", mp: 10, pow: 2.2, powGrowth: 0.35, hpCost: 0.08, maxLevel: 5, desc: "HPã‚’æ¶ˆè²»ã—ã¦é«˜ç«åŠ›ã‚’å©ãå‡ºã™" },
                    { id: 3, name: "é¼“èˆ", mp: 8, val: 30, valGrowth: 12, type: 'heal', maxLevel: 5, desc: "æ°—åˆã§HPã‚’å›å¾©ã™ã‚‹" },
                    { id: 4, name: "é‰„å£ã®æ§‹ãˆ", mp: 12, pow: 0.6, powGrowth: 0.12, maxLevel: 5, desc: "å …ã„ä¸€æ’ƒã§æŒä¹…æˆ¦ã«å¼·ã„" },
                    { id: 5, name: "ãƒ‰ãƒ©ã‚´ãƒ³ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼", mp: 25, pow: 4.5, powGrowth: 0.7, maxLevel: 5, desc: "æ¸¾èº«ã®æ–¬æ’ƒã€‚Lvã§è¶…ç«åŠ›" }
                ],
                passive: [
                    { id: 0, name: "ç­‹åŠ›å¢—å¼·", desc: "STR+3/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.str += 3 * d },
                    { id: 1, name: "é ‘å¼·", desc: "VIT+3/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.vit += 3 * d },
                    { id: 2, name: "è¡€ã®æ¸‡æœ›", desc: "å¸è¡€ç‡+2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.leechRate += 2 * d },
                    { id: 3, name: "åæ’ƒã®æ§‹ãˆ", desc: "è¢«å¼¾æ™‚ã®åæ’ƒç‡ãŒä¸Šæ˜‡", maxLevel: 5, logic: 'counter' },
                    { id: 4, name: "é‰„å£è£…å‚™", desc: "é˜²å…·ã§å—ã‘ã‚‹ãƒ€ãƒ¡ãƒ¼ã‚¸ãŒã•ã‚‰ã«æ¸›å°‘", maxLevel: 5, logic: 'armor_boost' },
                    { id: 5, name: "ä¸å±ˆã®é—˜å¿—", desc: "HP30%ä»¥ä¸‹ã§æ”»æ’ƒåŠ›ä¸Šæ˜‡", maxLevel: 5, logic: 'low_hp_boost' }
                ]
            },
            mage: {
                name: "é­”è¡“å¸«",
                active: [
                    { id: 0, name: "ãƒ•ã‚¡ã‚¤ã‚¢ãƒœãƒ¼ãƒ«", mp: 8, pow: 2.0, powGrowth: 0.3, isMagic: true, maxLevel: 5, desc: "ç‡ƒãˆä¸ŠãŒã‚‹ç«çƒã§ç„¼ãæ‰•ã†" },
                    { id: 1, name: "ã‚¢ã‚¤ã‚¹ãƒ©ãƒ³ã‚¹", mp: 10, pow: 2.3, powGrowth: 0.35, isMagic: true, accuracyBonus: 5, accuracyGrowth: 3, maxLevel: 5, desc: "é‹­ã„æ°·æ§ã§è²«ã" },
                    { id: 2, name: "ãƒãƒŠãƒ‰ãƒ¬ã‚¤ãƒ³", mp: 0, pow: 0.7, powGrowth: 0.1, isMagic: true, mpHeal: 0.4, mpHealGrowth: 0.05, maxLevel: 5, desc: "ä¸ãƒ€ãƒ¡ã«å¿œã˜ã¦MPã‚’å¸å" },
                    { id: 3, name: "ã‚µãƒ³ãƒ€ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ ", mp: 18, pow: 3.2, powGrowth: 0.45, isMagic: true, maxLevel: 5, desc: "é›·æ’ƒã‚’å©ãã¤ã‘ã‚‹åºƒç¯„å›²é­”æ³•" },
                    { id: 4, name: "ãƒ¡ãƒ†ã‚ª", mp: 30, pow: 5.0, powGrowth: 0.8, isMagic: true, maxLevel: 5, desc: "éš•çŸ³ã‚’å¬å–šã™ã‚‹å¤§é­”æ³•" },
                    { id: 5, name: "çµ‚ç„‰ã®ç¦å‘ª", mp: 50, pow: 10.0, powGrowth: 1.2, isMagic: true, maxLevel: 5, desc: "é­”åŠ›ã‚’è§£ãæ”¾ã¤ç¦å‘ª" }
                ],
                passive: [
                    { id: 0, name: "çŸ¥åŠ›å¢—å¼·", desc: "INT+4/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.int += 4 * d },
                    { id: 1, name: "é­”åŠ›å¾ªç’°", desc: "æœ€å¤§MP+15/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => { Game.player.maxMpFlat += 15 * d; } },
                    { id: 2, name: "ç‘æƒ³", desc: "MPè‡ªå‹•å›å¾©+2/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.mpRegen += 2 * d },
                    { id: 3, name: "é­”å°é›†ä¸­", desc: "ä¼šå¿ƒç‡+2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.critRate += 2 * d },
                    { id: 4, name: "é­”åŠ›è²«é€š", desc: "é­”æ³•è²«é€š+4%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.mPen += 4 * d },
                    { id: 5, name: "ç§˜å¥¥å¼·åŒ–", desc: "ä¸ãƒ€ãƒ¡å¢—åŠ +2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.damageBoost += 2 * d }
                ]
            },
            thief: {
                name: "ç›—è³Š",
                active: [
                    { id: 0, name: "ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ–", mp: 3, pow: 1.0, powGrowth: 0.15, accuracyBonus: 15, accuracyGrowth: 5, maxLevel: 5, desc: "ç´ æ—©ã„çªãã§ç¢ºå®Ÿã«å‰Šã‚‹" },
                    { id: 1, name: "ãƒ€ãƒ–ãƒ«ã‚¢ã‚¿ãƒƒã‚¯", mp: 7, pow: 0.85, powGrowth: 0.1, hits: 2, maxLevel: 5, desc: "äºŒé€£æ’ƒã§æ‰‹æ•°ã‚’ç¨¼ã" },
                    { id: 2, name: "æ¯’ã®åˆƒ", mp: 10, pow: 1.8, powGrowth: 0.25, critBonus: 5, critGrowth: 2, maxLevel: 5, desc: "æ€¥æ‰€ç‹™ã„ã§ä¼šå¿ƒç‡ä¸Šæ˜‡" },
                    { id: 3, name: "å¼·å¥ª", mp: 5, pow: 1.0, powGrowth: 0.1, expBonus: 15, expBonusGrowth: 5, maxLevel: 5, desc: "æ”»æ’ƒã—ãªãŒã‚‰çµŒé¨“å€¤ã‚’å¥ªã†" },
                    { id: 4, name: "å½±ç¸«ã„", mp: 12, pow: 2.2, powGrowth: 0.3, maxLevel: 5, desc: "å½±ã‹ã‚‰ä¸€æ’ƒã‚’åŠ ãˆã‚‹" },
                    { id: 5, name: "åƒæ‰‹è¦³éŸ³", mp: 30, pow: 1.1, powGrowth: 0.1, hits: 5, maxLevel: 5, desc: "åœ§å€’çš„ãªäº”é€£æ’ƒ" }
                ],
                passive: [
                    { id: 0, name: "ä¿Šæ•", desc: "DEX+3/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.dex += 3 * d },
                    { id: 1, name: "ç¥é€Ÿå›é¿", desc: "å›é¿ç‡+2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.evasionRate += 2 * d },
                    { id: 2, name: "ç›®åˆ©ã", desc: "ãƒ‰ãƒ­ãƒƒãƒ—ç‡+3%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.luck += 3 * d },
                    { id: 3, name: "å¹¸é‹ã®å¥³ç¥", desc: "è¿½åŠ çµŒé¨“å€¤+5%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.expBoost += 5 * d },
                    { id: 4, name: "æ€¥æ‰€æ”»æ’ƒ", desc: "ä¼šå¿ƒç‡+3%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.critRate += 3 * d },
                    { id: 5, name: "æš—æ®ºè€…ã®å¿ƒå¾—", desc: "æº€ã‚¿ãƒ³ã®æ•µã¸ã®åˆæ’ƒãŒå¼·åŒ–", maxLevel: 5, logic: 'first_hit_boost' }
                ]
            },
            ranger: {
                name: "ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼",
                active: [
                    { id: 0, name: "ãƒ—ãƒ¬ã‚·ã‚¸ãƒ§ãƒ³ã‚·ãƒ§ãƒƒãƒˆ", mp: 5, pow: 1.5, powGrowth: 0.2, accuracyBonus: 15, accuracyGrowth: 5, maxLevel: 5, desc: "ç‹™ã„ã™ã¾ã—ãŸä¸€å°„" },
                    { id: 1, name: "ãƒˆãƒªãƒ—ãƒ«ã‚·ãƒ§ãƒƒãƒˆ", mp: 10, pow: 0.8, powGrowth: 0.1, hits: 3, maxLevel: 5, desc: "ä¸‰é€£å°„ã§åœ§å€’ã™ã‚‹" },
                    { id: 2, name: "ãƒ–ãƒ©ãƒƒãƒ‰ã‚¢ãƒ­ãƒ¼", mp: 8, pow: 1.3, powGrowth: 0.2, leech: 8, leechGrowth: 2, maxLevel: 5, desc: "ä¸ãƒ€ãƒ¡ã®ä¸€éƒ¨ã‚’å¸åã™ã‚‹çŸ¢" },
                    { id: 3, name: "çˆ†è£‚çŸ¢", mp: 16, pow: 2.6, powGrowth: 0.4, maxLevel: 5, desc: "çˆ†ç™ºã§æ•µã‚’è²«ãå¼·æ’ƒ" },
                    { id: 4, name: "ãƒãƒ³ã‚¿ãƒ¼ã‚ºãƒ©ãƒƒã‚·ãƒ¥", mp: 18, pow: 1.0, powGrowth: 0.1, hits: 4, maxLevel: 5, desc: "é€£å°„ã§å‰Šã‚Šç¶šã‘ã‚‹" },
                    { id: 5, name: "ãƒ†ãƒ³ãƒšã‚¹ãƒˆãƒœãƒ¬ãƒ¼", mp: 32, pow: 1.4, powGrowth: 0.15, hits: 6, maxLevel: 5, desc: "åµã®ã‚ˆã†ãªçŸ¢ã®é›¨" }
                ],
                passive: [
                    { id: 0, name: "å°„æ’ƒè¨“ç·´", desc: "å‘½ä¸­ç‡+3%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.accuracy += 3 * d },
                    { id: 1, name: "ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚¢ã‚¤", desc: "ä¼šå¿ƒç‡+2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.critRate += 2 * d },
                    { id: 2, name: "é›†ä¸­", desc: "ä¸ãƒ€ãƒ¡å¢—åŠ +2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.damageBoost += 2 * d },
                    { id: 3, name: "é‡ç”Ÿã®å‹˜", desc: "å›é¿ç‡+1%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.evasionRate += 1 * d },
                    { id: 4, name: "ãƒ¬ã‚¢ãƒãƒ³ãƒˆ", desc: "ãƒ¬ã‚¢ãƒ‰ãƒ­ç‡+3%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.rareFind += 3 * d },
                    { id: 5, name: "ç²ç‰©ã®è¿½è·¡", desc: "ã‚´ãƒ¼ãƒ«ãƒ‰å¢—åŠ ç‡+5%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.goldBoost += 5 * d }
                ]
            },
            paladin: {
                name: "è–é¨å£«",
                active: [
                    { id: 0, name: "ãƒ›ãƒ¼ãƒªãƒ¼ã‚¹ãƒã‚¤ãƒˆ", mp: 6, pow: 1.7, powGrowth: 0.25, isMagic: true, maxLevel: 5, desc: "è–ãªã‚‹è¡æ’ƒã§æµ„åŒ–ã™ã‚‹" },
                    { id: 1, name: "ã‚·ãƒ¼ãƒ«ãƒ‰ãƒãƒ£ãƒ¼ã‚¸", mp: 8, pow: 1.3, powGrowth: 0.2, accuracyBonus: 10, accuracyGrowth: 5, maxLevel: 5, desc: "ç›¾ã§çªæ’ƒã—æ•µã‚’å´©ã™" },
                    { id: 2, name: "ã‚»ã‚¤ã‚¯ãƒªãƒƒãƒ‰ãƒ’ãƒ¼ãƒ«", mp: 12, val: 40, valGrowth: 15, type: 'heal', isMagic: true, maxLevel: 5, desc: "è–ãªã‚‹åŠ›ã§HPã‚’å›å¾©" },
                    { id: 3, name: "ãƒ©ã‚¤ãƒˆãƒãƒ¼ã‚¹ãƒˆ", mp: 18, pow: 2.8, powGrowth: 0.4, isMagic: true, maxLevel: 5, desc: "çœ©ã„å…‰ã§æ•µã‚’æ’ƒã¤" },
                    { id: 4, name: "ã‚¸ãƒ£ãƒƒã‚¸ãƒ¡ãƒ³ãƒˆ", mp: 22, pow: 2.0, powGrowth: 0.3, isMagic: true, hits: 2, maxLevel: 5, desc: "è–ãªã‚‹è£ãã‚’é€£æ’ƒã§ä¸ãˆã‚‹" },
                    { id: 5, name: "è–åŸŸã®è£ã", mp: 35, pow: 4.8, powGrowth: 0.7, isMagic: true, maxLevel: 5, desc: "è–åŸŸã®å…‰ãŒé™ã‚Šæ³¨ãä¸€æ’ƒ" }
                ],
                passive: [
                    { id: 0, name: "ä¿¡ä»°", desc: "æœ€å¤§HP+15/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.maxHpFlat += 15 * d },
                    { id: 1, name: "è–ãªã‚‹å®ˆã‚Š", desc: "è¢«ãƒ€ãƒ¡è»½æ¸›+2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.damageReduction += 2 * d },
                    { id: 2, name: "è–ç™’åŠ›", desc: "HPè‡ªå‹•å›å¾©+2/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.hpRegen += 2 * d },
                    { id: 3, name: "æ•¬è™”", desc: "MPè‡ªå‹•å›å¾©+1/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.mpRegen += 1 * d },
                    { id: 4, name: "ç¥ç½°", desc: "ä¸ãƒ€ãƒ¡å¢—åŠ +2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.damageBoost += 2 * d },
                    { id: 5, name: "å®ˆè­·èª“ç´„", desc: "é˜²å¾¡åŠ¹ç‡+4%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.defenseEfficiency += 4 * d }
                ]
            },
            monk: {
                name: "æ‹³é—˜å£«",
                active: [
                    { id: 0, name: "é€£æ‰“æ‹³", mp: 4, pow: 0.7, powGrowth: 0.1, hits: 3, maxLevel: 5, desc: "ç´ æ—©ã„é€£æ‰“ã§å‰Šã‚‹" },
                    { id: 1, name: "æ°—åŠŸæ³¢", mp: 8, pow: 1.8, powGrowth: 0.25, maxLevel: 5, desc: "æ°—ã‚’é£›ã°ã—ã¦æ”»æ’ƒã™ã‚‹" },
                    { id: 2, name: "ç ´å²©æ’ƒ", mp: 10, pow: 2.4, powGrowth: 0.3, maxLevel: 5, desc: "å²©ã‚’ã‚‚ç •ãä¸€æ’ƒ" },
                    { id: 3, name: "å›å¤©è„š", mp: 12, pow: 1.0, powGrowth: 0.15, hits: 4, accuracyBonus: 10, accuracyGrowth: 5, maxLevel: 5, desc: "å›è»¢è¹´ã‚Šã§é€£æ’ƒ" },
                    { id: 4, name: "æ´»åŠ›å¾ªç’°", mp: 10, val: 25, valGrowth: 10, type: 'heal', maxLevel: 5, desc: "å†…ãªã‚‹æ°—ã§HPã‚’å›å¾©" },
                    { id: 5, name: "ç„¡æˆ‘ã®å¢ƒåœ°", mp: 30, pow: 3.8, powGrowth: 0.6, critBonus: 10, critGrowth: 3, maxLevel: 5, desc: "é›†ä¸­ã—ã¦æ¸¾èº«ã®ä¸€æ’ƒ" }
                ],
                passive: [
                    { id: 0, name: "ä½“è¡“é›éŒ¬", desc: "STR+2/ãƒ¬ãƒ™ãƒ« & DEX+2/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => { Game.player.str += 2 * d; Game.player.dex += 2 * d; } },
                    { id: 1, name: "æ°—ã®æµã‚Œ", desc: "HPåŠ¹ç‡+3%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.hpEfficiency += 3 * d },
                    { id: 2, name: "å†…åŠŸ", desc: "MPåŠ¹ç‡+3%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.mpEfficiency += 3 * d },
                    { id: 3, name: "é—˜å¿—", desc: "ä¼šå¿ƒãƒ€ãƒ¡ãƒ¼ã‚¸+8%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.critDamage += 8 * d },
                    { id: 4, name: "éœèº«", desc: "å›é¿ç‡+2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.evasionRate += 2 * d },
                    { id: 5, name: "é—˜æ°—å¸å", desc: "å¸è¡€ç‡+2%/ãƒ¬ãƒ™ãƒ«", maxLevel: 5, apply: (d) => Game.player.leechRate += 2 * d }
                ]
            }
        };

        const StatusDefs = {
            poison: { id: 'poison', name: 'æ¯’', effectType: 'poison', stackable: true, maxStacks: 5, defaultTurns: 3, icon: 'fa-skull-crossbones' },
            bleed: { id: 'bleed', name: 'å‡ºè¡€', effectType: 'bleed', stackable: true, maxStacks: 5, defaultTurns: 3, icon: 'fa-droplet' },
            weaken: { id: 'weaken', name: 'å¼±ä½“', effectType: 'weaken', stackable: false, maxStacks: 1, defaultTurns: 2, icon: 'fa-down-long' },
            vulnerable: { id: 'vulnerable', name: 'è„†å¼±', effectType: 'vulnerable', stackable: false, maxStacks: 1, defaultTurns: 2, icon: 'fa-shield-halved' },
            buff: { id: 'buff', name: 'å¼·åŒ–', effectType: 'buff', stackable: true, maxStacks: 3, defaultTurns: 2, icon: 'fa-arrow-up-long' }
        };

        const EnemyBases = [
            { name: "ã‚¹ãƒ©ã‚¤ãƒ ", icon: "fa-bacteria", hp: 30, str: 7, exp: 12 },
            { name: "ã‚³ã‚¦ãƒ¢ãƒª", icon: "fa-moon", hp: 35, str: 10, exp: 15 },
            { name: "ã‚´ãƒ–ãƒªãƒ³", icon: "fa-user-ninja", hp: 60, str: 14, exp: 25 },
            { name: "ã‚¹ã‚±ãƒ«ãƒˆãƒ³", icon: "fa-skull", hp: 80, str: 20, exp: 40 },
            { name: "ã‚´ãƒ¼ãƒ¬ãƒ ", icon: "fa-mountain", hp: 150, str: 25, exp: 70 },
            { name: "ã‚·ãƒ£ãƒ‰ã‚¦", icon: "fa-ghost", hp: 200, str: 35, exp: 100 },
            { name: "ãƒ‰ãƒ©ã‚´ãƒ³", icon: "fa-dragon", hp: 500, str: 60, exp: 300 }
        ];

        const ItemPrefix = [
            { name: "æ™®é€šã®", mul: 1.0, r: "common" },
            { name: "é‹­ã„", mul: 1.2, r: "uncommon" },
            { name: "ä¸ˆå¤«ãª", mul: 1.3, r: "uncommon" },
            { name: "é­”æ³•ã®", mul: 1.5, r: "rare" },
            { name: "ç‹å®¶ã®", mul: 2.0, r: "epic" },
            { name: "ç¥è©±ã®", mul: 4.5, r: "legendary" }
        ];

        // --- CORE LOGIC ---
        window.onload = () => {
            spawn();
            updateUI();
            switchJob('warrior');
            switchSkillType('active');
        };

        function switchPage(p) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${p}`).classList.add('active');
            document.getElementById(`nav-${p}`).classList.add('active');
            if (p === 'skill') document.getElementById('nav-sp-dot').classList.add('hidden');
        }

        function switchJob(job) {
            Game.currentJobTab = job;
            document.querySelectorAll('.job-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${job}`).classList.add('active');
            renderSkillList();
        }

        function getSkillLevel(job, type, idx) {
            return Game.player.skills[job]?.[type]?.[idx] || 0;
        }

        function getPassiveLevel(job, idx) {
            return Game.player.skills[job]?.passive?.[idx] || 0;
        }

        function buildActiveSkill(job, idx, level) {
            const base = JobData[job].active[idx];
            const lv = Math.max(1, level);
            const scale = lv - 1;
            const skill = { ...base, level: lv, maxLevel: base.maxLevel || 5 };
            if (base.mp !== undefined) skill.mp = Math.max(0, Math.round(base.mp + (base.mpGrowth || 0) * scale));
            if (base.pow !== undefined) skill.pow = Math.max(0, base.pow + (base.powGrowth || 0) * scale);
            if (base.val !== undefined) skill.val = Math.max(0, Math.round(base.val + (base.valGrowth || 0) * scale));
            if (base.hits !== undefined) skill.hits = Math.max(1, Math.round(base.hits + (base.hitsGrowth || 0) * scale));
            if (base.mpHeal !== undefined) skill.mpHeal = Math.max(0, base.mpHeal + (base.mpHealGrowth || 0) * scale);
            if (base.expBonus !== undefined) skill.expBonus = Math.max(0, Math.round(base.expBonus + (base.expBonusGrowth || 0) * scale));
            if (base.accuracyBonus !== undefined) skill.accuracyBonus = Math.round(base.accuracyBonus + (base.accuracyGrowth || 0) * scale);
            if (base.critBonus !== undefined) skill.critBonus = Math.round(base.critBonus + (base.critGrowth || 0) * scale);
            if (base.leech !== undefined) skill.leech = Math.max(0, base.leech + (base.leechGrowth || 0) * scale);
            return skill;
        }

        function getSlotSkill(slot) {
            if (!slot) return null;
            const level = getSkillLevel(slot.job, 'active', slot.idx);
            if (level <= 0) return null;
            return buildActiveSkill(slot.job, slot.idx, level);
        }

        function getNextSlotSkill() {
            const slots = Game.player.skillSlots;
            const start = Game.player.skillSlotIndex || 0;
            for (let i = 0; i < slots.length; i++) {
                const idx = (start + i) % slots.length;
                const skill = getSlotSkill(slots[idx]);
                if (skill) {
                    return { skill, slotIndex: idx, nextIndex: (idx + 1) % slots.length };
                }
            }
            return { skill: null, slotIndex: start, nextIndex: (start + 1) % slots.length };
        }

        function setSkillSlotTarget(idx) {
            Game.player.skillSlotTarget = idx;
            renderSkillList();
            updateUI();
        }

        function assignSkillToSlot(job, idx) {
            const level = getSkillLevel(job, 'active', idx);
            if (level <= 0) return;
            Game.player.skillSlots[Game.player.skillSlotTarget] = { job, idx };
            updateUI();
        }

        function clearSkillSlot(idx) {
            Game.player.skillSlots[idx] = null;
            updateUI();
        }

        function getDerivedStats() {
            const p = Game.player;
            const maxHp = Math.max(1, Math.floor((p.maxHp + p.maxHpFlat) * (1 + p.hpEfficiency / 100)));
            const maxMp = Math.max(0, Math.floor((p.maxMp + p.maxMpFlat) * (1 + p.mpEfficiency / 100)));
            const atkBase = p.str + (p.weapon?.val || 0) + p.attackFlat;
            const atk = Math.max(0, Math.floor(atkBase * (1 + p.attackEfficiency / 100)));
            const defBase = p.vit + (p.armor?.val || 0) + p.defenseFlat;
            const def = Math.max(0, Math.floor(defBase * (1 + p.defenseEfficiency / 100)));
            return { maxHp, maxMp, atk, def };
        }

        function applyAutoRegen() {
            const p = Game.player;
            const derived = getDerivedStats();
            if (p.hpRegen > 0) {
                p.hp = Math.min(derived.maxHp, p.hp + p.hpRegen);
            }
            if (p.mpRegen > 0) {
                p.mp = Math.min(derived.maxMp, p.mp + p.mpRegen);
            }
        }

        function advanceStatusEffects(target, phase) {
            if (!target || !Array.isArray(target.statusEffects)) return;
            target.statusEffects = target.statusEffects.filter(effect => effect.turns > 0);
            if (phase === 'start') {
                target.statusEffects.forEach(effect => {
                    const def = StatusDefs[effect.id];
                    if (!def) return;
                    if (def.effectType === 'poison' || def.effectType === 'bleed') {
                        const stacks = Math.max(1, effect.stacks || 1);
                        const dmg = Math.max(1, stacks);
                        target.hp = Math.max(0, target.hp - dmg);
                    }
                });
            }
            if (phase === 'end') {
                target.statusEffects.forEach(effect => {
                    effect.turns -= 1;
                });
                target.statusEffects = target.statusEffects.filter(effect => effect.turns > 0);
            }
        }

        function applyStatusEffect(target, effectId, stacks = 1, turns = null) {
            const def = StatusDefs[effectId];
            if (!def) return;
            if (!Array.isArray(target.statusEffects)) {
                target.statusEffects = [];
            }
            const duration = turns ?? def.defaultTurns ?? 1;
            const maxStacks = def.maxStacks ?? stacks;
            const existing = target.statusEffects.find(effect => effect.id === effectId);
            if (existing) {
                if (def.stackable) {
                    existing.stacks = Math.min(maxStacks, existing.stacks + stacks);
                } else {
                    existing.stacks = 1;
                }
                existing.turns = Math.max(existing.turns, duration);
            } else {
                target.statusEffects.push({
                    id: effectId,
                    stacks: def.stackable ? Math.min(maxStacks, stacks) : 1,
                    turns: duration
                });
            }
        }

        const infoModal = document.getElementById('status-info-modal');
        const openInfoModal = () => {
            infoModal.classList.remove('hidden');
            infoModal.classList.add('flex');
        };
        const closeInfoModal = () => {
            infoModal.classList.add('hidden');
            infoModal.classList.remove('flex');
        };
        document.getElementById('secondary-info-btn').addEventListener('click', openInfoModal);
        document.getElementById('status-info-close').addEventListener('click', closeInfoModal);
        document.getElementById('status-info-close-bottom').addEventListener('click', closeInfoModal);
        infoModal.addEventListener('click', (event) => {
            if (event.target === infoModal) closeInfoModal();
        });

        function switchSkillType(type) {
            Game.currentSkillType = type;
            document.querySelectorAll('.type-tab').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${type}`).classList.add('active');
            renderSkillList();
        }

        function renderSkillList() {
            const list = document.getElementById('skill-list');
            list.innerHTML = '';
            const data = JobData[Game.currentJobTab][Game.currentSkillType];
            
            data.forEach((skill, idx) => {
                const level = getSkillLevel(Game.currentJobTab, Game.currentSkillType, idx);
                const maxLevel = skill.maxLevel || 5;
                const isLearned = level > 0;
                const isMax = level >= maxLevel;
                const card = document.createElement('div');
                card.className = `p-4 rounded-2xl border-2 transition-all shadow-sm ${isLearned ? 'bg-white border-slate-800' : 'bg-slate-100 border-slate-200 opacity-60'}`;
                
                let actionPart = '';
                if (!isLearned) {
                    actionPart = `<button onclick="learnSkill('${Game.currentJobTab}', '${Game.currentSkillType}', ${idx})" class="shrink-0 px-4 py-2 bg-slate-800 text-white text-[10px] font-black rounded-xl">1SPç¿’å¾—</button>`;
                } else if (!isMax) {
                    actionPart = `<button onclick="learnSkill('${Game.currentJobTab}', '${Game.currentSkillType}', ${idx})" class="shrink-0 px-4 py-2 bg-amber-500 text-white text-[10px] font-black rounded-xl">1SPå¼·åŒ–</button>`;
                } else {
                    actionPart = `<span class="shrink-0 text-xs font-black text-slate-400"><i class="fas fa-check-circle"></i></span>`;
                }

                if (Game.currentSkillType === 'active' && isLearned) {
                    const targetSlot = Game.player.skillSlotTarget + 1;
                    actionPart = `
                        <div class="flex items-center gap-2">
                            ${actionPart}
                            <button onclick="assignSkillToSlot('${Game.currentJobTab}', ${idx})" class="shrink-0 px-3 py-2 bg-blue-600 text-white text-[10px] font-black rounded-xl">S${targetSlot}ã‚»ãƒƒãƒˆ</button>
                        </div>
                    `;
                }

                const displaySkill = (Game.currentSkillType === 'active')
                    ? buildActiveSkill(Game.currentJobTab, idx, Math.max(1, level || 1))
                    : skill;

                card.innerHTML = `
                    <div class="flex justify-between items-center gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-0.5">
                                <span class="font-black text-sm truncate">${displaySkill.name}</span>
                                ${displaySkill.mp !== undefined ? `<span class="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded-full font-bold">MP ${displaySkill.mp}</span>` : ''}
                                <span class="text-[9px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded-full font-bold">Lv ${level}/${maxLevel}</span>
                            </div>
                            <p class="text-[10px] text-slate-500 leading-tight">${displaySkill.desc}</p>
                        </div>
                        ${actionPart}
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function learnSkill(job, type, idx) {
            const skill = JobData[job][type][idx];
            const current = getSkillLevel(job, type, idx);
            const maxLevel = skill.maxLevel || 5;
            if (Game.player.sp <= 0 || current >= maxLevel) return;
            Game.player.sp--;
            Game.player.skills[job][type][idx] = current + 1;
            
            if (type === 'passive' && skill.apply) {
                skill.apply(1);
            }

            renderSkillList();
            updateUI();
        }

        function spawn() {
            const scale = 1 + (Game.floor * 0.22);
            const baseIdx = Math.min(EnemyBases.length - 1, Math.floor(Game.floor / 5));
            const base = EnemyBases[baseIdx];
            Game.enemy = { 
                ...base, 
                maxHp: Math.floor(base.hp * scale), 
                hp: Math.floor(base.hp * scale), 
                str: Math.floor(base.str * scale),
                statusEffects: []
            };
            Game.state = 'combat';
        }

        document.getElementById('action-btn').onclick = () => {
            if (Game.state === 'dead') return;
            if (Game.state === 'idle') {
                Game.floor++;
                spawn();
                addLog(`B${Game.floor}ã¸æ½œå…¥...`);
                updateUI();
                return;
            }

            advanceStatusEffects(Game.player, 'start');
            if (Game.player.hp <= 0) {
                die();
                updateUI();
                return;
            }

            const slotResult = getNextSlotSkill();
            let currentSkill = { name: 'é€šå¸¸æ”»æ’ƒ', mp: 0, pow: 1.0 };
            let isMagic = false;
            
            if (slotResult.skill) {
                currentSkill = slotResult.skill;
                if (currentSkill.isMagic) isMagic = true;
            }

            if (Game.player.mp < currentSkill.mp) {
                addLog("MPä¸è¶³ï¼é€šå¸¸æ”»æ’ƒ", "text-blue-400");
                currentSkill = { name: 'é€šå¸¸æ”»æ’ƒ', mp: 0, pow: 1.0 };
                isMagic = false;
            }

            Game.player.skillSlotIndex = slotResult.nextIndex;

            const derived = getDerivedStats();

            if (currentSkill.hpCost) {
                const cost = Math.floor(derived.maxHp * currentSkill.hpCost);
                Game.player.hp = Math.max(1, Game.player.hp - cost);
            }

            Game.player.mp -= currentSkill.mp;

            if (currentSkill.type === 'heal') {
                const amt = Math.floor(currentSkill.val + (Game.player.int * 1.2));
                Game.player.hp = Math.min(derived.maxHp, Game.player.hp + amt);
                addLog(`ã€å›å¾©ã€‘${amt}HP`, "text-green-500");
                dmgText(amt, true);
            } else {
                let hits = currentSkill.hits || 1;
                let totalDamage = 0;
                
                for(let i=0; i<hits; i++){
                    let hitChance = Math.min(100, Game.player.accuracy + (currentSkill.accuracyBonus || 0));
                    if (Math.random() * 100 > hitChance) {
                        continue;
                    }
                    // Base Attack Power Calculation
                    let atkBase = isMagic ? (Game.player.int * 2) : derived.atk;
                    
                    // Critical Check
                    let isCrit = Math.random() * 100 < (Game.player.critRate + (currentSkill.critBonus || 0));
                    let dmg = Math.floor(currentSkill.pow * atkBase * (0.9 + Math.random() * 0.2));
                    if (isCrit) dmg = Math.floor(dmg * (Game.player.critDamage / 100));

                    // Passive: Low HP boost
                    const lowHpLevel = getPassiveLevel('warrior', 5);
                    if (lowHpLevel > 0 && Game.player.hp < derived.maxHp * 0.3) {
                        dmg = Math.floor(dmg * (1 + 0.1 * lowHpLevel));
                    }
                    // Passive: First hit boost
                    const firstHitLevel = getPassiveLevel('thief', 5);
                    if (firstHitLevel > 0 && Game.enemy.hp === Game.enemy.maxHp) {
                        dmg = Math.floor(dmg * (1 + 0.25 * firstHitLevel));
                    }

                    if (Game.player.damageBoost > 0) {
                        dmg = Math.floor(dmg * (1 + Game.player.damageBoost / 100));
                    }

                    dmg = Math.max(1, dmg);
                    Game.enemy.hp = Math.max(0, Game.enemy.hp - dmg);
                    totalDamage += dmg;
                    
                    // Leech
                    const totalLeech = Game.player.leechRate + (currentSkill.leech || 0);
                    if (totalLeech > 0) {
                        let l = Math.floor(dmg * (totalLeech / 100));
                        if (l > 0) {
                            Game.player.hp = Math.min(derived.maxHp, Game.player.hp + l);
                        }
                    }
                }
                
                if (totalDamage === 0) {
                    addLog("æ”»æ’ƒãŒå¤–ã‚ŒãŸï¼", "text-slate-400");
                    dmgText("MISS", false);
                } else {
                    addLog(`${currentSkill.name}ï¼ ${totalDamage}ã®ãƒ€ãƒ¡ãƒ¼ã‚¸`);
                    dmgText(totalDamage);
                }

                if (currentSkill.mpHeal && totalDamage > 0) {
                    const mHeal = Math.floor(totalDamage * currentSkill.mpHeal);
                    Game.player.mp = Math.min(derived.maxMp, Game.player.mp + mHeal);
                }
                if (currentSkill.expBonus && totalDamage > 0) {
                    let b = Math.floor(Game.player.next * (currentSkill.expBonus / 100));
                    Game.player.exp += b;
                    addLog(`EXP +${b} å¥ªå–ï¼`);
                }

                document.getElementById('enemy-visual').classList.add('shake');
                setTimeout(()=>document.getElementById('enemy-visual').classList.remove('shake'), 200);
            }

            advanceStatusEffects(Game.player, 'end');
            applyAutoRegen();
            if (Game.enemy.hp <= 0) {
                victory();
            } else {
                setTimeout(enemyTurn, 300);
            }
            updateUI();
        };

        function enemyTurn() {
            if (Game.state !== 'combat') return;

            advanceStatusEffects(Game.enemy, 'start');
            if (Game.enemy.hp <= 0) {
                victory();
                updateUI();
                return;
            }
            
            // Evasion Check
            if (Math.random() * 100 < Game.player.evasionRate) {
                addLog("æ”»æ’ƒã‚’å›é¿ï¼", "text-blue-500 font-bold");
                dmgText("MISS", false);
                advanceStatusEffects(Game.enemy, 'end');
                updateUI();
                return;
            }

            const derived = getDerivedStats();
            let d = Math.floor(Game.enemy.str * (0.8 + Math.random() * 0.4)) - derived.def;
            // Passive: Armor Boost
            const armorBoostLevel = getPassiveLevel('warrior', 4);
            if (armorBoostLevel > 0) d -= Math.floor((Game.player.armor?.val||0) * 0.15 * armorBoostLevel);
            
            if (Game.player.damageReduction > 0) {
                d = Math.floor(d * (1 - Game.player.damageReduction / 100));
            }
            d = Math.max(1, d);
            Game.player.hp = Math.max(0, Game.player.hp - d);
            addLog(`${Game.enemy.name}ï¼š${d}ãƒ€ãƒ¡`, "text-red-400");
            if (Math.random() < 0.2) {
                applyStatusEffect(Game.player, 'poison');
                addLog("æ¯’ã‚’å—ã‘ãŸï¼", "text-green-600");
            }
            
            // Passive: MP Regen
            const mpRegenLevel = getPassiveLevel('mage', 2);
            if (mpRegenLevel > 0) {
                Game.player.mp = Math.min(derived.maxMp, Game.player.mp + (2 * mpRegenLevel));
            }
            
            // Passive: Counter
            const counterLevel = getPassiveLevel('warrior', 3);
            if (counterLevel > 0 && Math.random() < (0.03 * counterLevel)) {
                let cdmg = Math.floor(Game.player.str * (0.2 + 0.1 * counterLevel));
                Game.enemy.hp = Math.max(0, Game.enemy.hp - cdmg);
                addLog("ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼", "text-orange-500");
                dmgText(cdmg);
                if (Game.enemy.hp <= 0) victory();
            }

            advanceStatusEffects(Game.enemy, 'end');
            applyAutoRegen();
            if (Game.player.hp <= 0) die();
            updateUI();
        }

        function victory() {
            Game.state = 'idle';
            addLog(`è¨ä¼æˆåŠŸï¼`, "text-yellow-500 font-black");
            let gain = Game.enemy.exp;
            // Exp Boost Calculation
            gain = Math.floor(gain * (1 + Game.player.expBoost / 100));
            Game.player.exp += gain;

            if (Game.player.exp >= Game.player.next) {
                Game.player.level++;
                Game.player.exp -= Game.player.next;
                Game.player.next = Math.floor(Game.player.next * 1.4);
                Game.player.maxHp += 25; Game.player.hp = Game.player.maxHp;
                Game.player.maxMp += 15; Game.player.mp = Game.player.maxMp;
                Game.player.str += 3; Game.player.vit += 3; Game.player.int += 3; Game.player.dex += 2;
                Game.player.sp += 3;
                addLog(`LEVEL UP! [${Game.player.level}]`, "text-blue-400 font-black");
                document.getElementById('nav-sp-dot').classList.remove('hidden');
            }
            // Drop Luck Check
            let dropChance = 0.5 + (Game.player.luck / 100);
            if (Math.random() < dropChance) drop();
        }

        function die() {
            Game.state = 'dead';
            const lostExp = Math.floor(Game.player.next * 0.1);
            document.getElementById('lost-exp-val').innerText = lostExp;
            Game.player.exp = Math.max(0, Game.player.exp - lostExp);
            Game.floor = Math.max(1, Game.floor - 20);
            document.getElementById('death-overlay').style.display = 'flex';
        }

        function revive() {
            const derived = getDerivedStats();
            Game.player.hp = derived.maxHp;
            Game.player.mp = derived.maxMp;
            document.getElementById('death-overlay').style.display = 'none';
            document.getElementById('full-log-container').innerHTML = '';
            addLog("å‘½ã‹ã‚‰ãŒã‚‰ç”Ÿé‚„ã—ãŸ...", "text-slate-400 italic");
            spawn();
            updateUI();
            switchPage('battle');
        }

        function addLog(m, c="") {
            const div = document.createElement('div');
            div.className = c;
            div.innerText = `> ${m}`;
            const full = document.getElementById('full-log-container');
            full.prepend(div);
            if (full.children.length > 50) full.lastChild.remove();
            Game.logs.unshift({m, c});
            if (Game.logs.length > 3) Game.logs.pop();
            for(let i=0; i<3; i++) {
                const el = document.getElementById(`mini-log-${i}`);
                if (Game.logs[i]) {
                    el.innerText = Game.logs[i].m;
                    el.className = Game.logs[i].c || (i===0 ? 'text-slate-800 font-bold' : 'text-slate-400');
                }
            }
        }

        function dmgText(v, isH=false) {
            const el = document.createElement('div');
            el.className = `damage-text ${isH?'text-green-500':'text-red-600'}`;
            el.innerText = v;
            el.style.left = (35 + Math.random()*30) + '%';
            el.style.top = (35 + Math.random()*30) + '%';
            document.getElementById('damage-layer').appendChild(el);
            setTimeout(()=>el.remove(), 800);
        }

        function drop() {
            const isW = Math.random() < 0.6;
            let prefixIdx = Math.floor(Math.random()*ItemPrefix.length);
            if (Game.player.rareFind > 0 && Math.random() * 100 < Game.player.rareFind) {
                prefixIdx = Math.min(ItemPrefix.length - 1, prefixIdx + 1);
            }
            const p = ItemPrefix[prefixIdx];
            const baseVal = Game.floor * 2 + 5;
            const val = Math.floor(baseVal * p.mul);
            Game.tempLoot = { name: p.name + (isW ? "å‰£" : "é§"), type: isW ? 'weapon' : 'armor', val: val, r: p.r };
            document.getElementById('loot-display').innerHTML = `
                <div class="text-[10px] text-slate-400 mb-1 uppercase font-black">${Game.tempLoot.type} Found</div>
                <div class="text-xl font-black rarity-${Game.tempLoot.r}">${Game.tempLoot.name}</div>
                <div class="font-black text-slate-500 mt-1">${isW?'ATK':'DEF'} +${val}</div>
            `;
            document.getElementById('loot-modal').style.display = 'flex';
            Game.state = 'loot';
        }

        function closeLoot(take) {
            if (take) {
                if (Game.player.inventory.length >= 20) { return; }
                Game.player.inventory.push(Game.tempLoot);
                document.getElementById('nav-inv-dot').classList.remove('hidden');
            }
            document.getElementById('loot-modal').style.display = 'none';
            Game.state = 'idle';
            updateUI();
        }

        function equip(idx) {
            const item = Game.player.inventory[idx];
            const old = Game.player[item.type];
            Game.player[item.type] = item;
            Game.player.inventory.splice(idx, 1);
            if (old) Game.player.inventory.push(old);
            updateUI();
        }

        document.getElementById('rest-btn').onclick = () => {
            if (Game.state !== 'idle') return;
            const derived = getDerivedStats();
            Game.player.hp = derived.maxHp;
            Game.player.mp = derived.maxMp;
            addLog("ã‚­ãƒ£ãƒ³ãƒ—ã§ä¼‘æ¯ã€‚å…¨å›å¾©ï¼");
            updateUI();
        };

        function updateUI() {
            const p = Game.player;
            const derived = getDerivedStats();
            document.getElementById('floor-display').innerText = Game.floor;
            document.getElementById('header-lvl').innerText = p.level;
            document.getElementById('header-sp').innerText = p.sp;
            document.getElementById('skill-sp-display').innerText = p.sp;

            // Health/Mana/Exp
            p.hp = Math.min(p.hp, derived.maxHp);
            p.mp = Math.min(p.mp, derived.maxMp);
            document.getElementById('player-hp-text').innerText = `${p.hp}/${derived.maxHp}`;
            document.getElementById('player-hp-bar').style.width = (p.hp/derived.maxHp*100)+'%';
            document.getElementById('player-mp-text').innerText = `${p.mp}/${derived.maxMp}`;
            document.getElementById('player-mp-bar').style.width = (p.mp/derived.maxMp*100)+'%';
            document.getElementById('player-exp-text-battle').innerText = `${p.exp}/${p.next}`;
            document.getElementById('player-exp-bar-battle').style.width = (p.exp/p.next*100)+'%';

            const e = Game.enemy;
            if (e) {
                document.getElementById('enemy-name').innerText = e.name;
                document.getElementById('enemy-hp-text').innerText = `${e.hp}/${e.maxHp}`;
                document.getElementById('enemy-hp-bar').style.width = (e.hp/e.maxHp*100)+'%';
                document.getElementById('enemy-visual').innerHTML = `<i class="fas ${e.icon}"></i>`;
            }

            // Skill Slots
            const battleSlots = document.getElementById('battle-skill-slots');
            if (battleSlots) {
                battleSlots.innerHTML = '';
                Game.player.skillSlots.forEach((slot, idx) => {
                    const skill = getSlotSkill(slot);
                    const isNext = idx === Game.player.skillSlotIndex;
                    const card = document.createElement('div');
                    card.className = `rounded-xl border px-2 py-2 text-center text-[10px] font-bold ${
                        isNext ? 'border-slate-800 bg-slate-100 text-slate-900' : 'border-slate-200 bg-slate-50 text-slate-400'
                    }`;
                    card.innerHTML = `
                        <div class="text-[9px] font-black">S${idx + 1}</div>
                        <div class="truncate">${skill ? skill.name : 'æœªè¨­å®š'}</div>
                        <div class="text-[9px] ${skill ? 'text-blue-500' : 'text-slate-300'}">MP ${skill ? skill.mp : '-'}</div>
                    `;
                    battleSlots.appendChild(card);
                });
            }

            const slotSettings = document.getElementById('skill-slot-settings');
            if (slotSettings) {
                slotSettings.innerHTML = '';
                Game.player.skillSlots.forEach((slot, idx) => {
                    const skill = getSlotSkill(slot);
                    const wrapper = document.createElement('div');
                    wrapper.className = "flex items-center gap-2";

                    const slotButton = document.createElement('button');
                    slotButton.className = `flex-1 text-left px-3 py-2 rounded-xl border text-[11px] font-bold ${
                        Game.player.skillSlotTarget === idx ? 'border-slate-800 bg-slate-800 text-white' : 'border-slate-200 bg-slate-50 text-slate-500'
                    }`;
                    slotButton.innerHTML = `
                        <div class="text-[9px] font-black">S${idx + 1}</div>
                        <div class="truncate">${skill ? skill.name : 'æœªè¨­å®š'}</div>
                    `;
                    slotButton.addEventListener('click', () => setSkillSlotTarget(idx));

                    const clearButton = document.createElement('button');
                    clearButton.className = `w-10 h-10 rounded-xl border flex items-center justify-center ${
                        skill ? 'border-slate-200 text-slate-500 bg-white' : 'border-slate-100 text-slate-300 bg-slate-50'
                    }`;
                    clearButton.innerHTML = '<i class="fas fa-xmark"></i>';
                    if (skill) {
                        clearButton.addEventListener('click', () => clearSkillSlot(idx));
                    } else {
                        clearButton.disabled = true;
                    }

                    wrapper.appendChild(slotButton);
                    wrapper.appendChild(clearButton);
                    slotSettings.appendChild(wrapper);
                });
            }

            // Button Control
            const btn = document.getElementById('action-btn');
            if (Game.state === 'combat') {
                btn.innerHTML = `<i class="fas fa-sword"></i> <span>æ”»æ’ƒ</span>`;
                btn.className = "w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg flex items-center justify-center gap-2";
            } else {
                btn.innerHTML = `<i class="fas fa-shoe-prints"></i> <span>æ¬¡ã®éšå±¤ã¸</span>`;
                btn.className = "w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-transform text-lg flex items-center justify-center gap-2";
            }

            // Status Details
            document.getElementById('status-lvl').innerText = p.level;
            document.getElementById('status-atk').innerText = derived.atk;
            document.getElementById('status-def').innerText = derived.def;
            document.getElementById('status-int').innerText = p.int;
            document.getElementById('status-dex').innerText = p.dex;
            document.getElementById('status-exp').innerText = p.exp;
            document.getElementById('status-next').innerText = p.next;
            document.getElementById('status-exp-bar').style.width = (p.exp/p.next*100)+'%';
            
            // Secondary Stats Display
            document.getElementById('stat-max-hp').innerText = p.maxHpFlat;
            document.getElementById('stat-hp-eff').innerText = p.hpEfficiency + "%";
            document.getElementById('stat-max-mp').innerText = p.maxMpFlat;
            document.getElementById('stat-mp-eff').innerText = p.mpEfficiency + "%";
            document.getElementById('stat-atk-flat').innerText = p.attackFlat;
            document.getElementById('stat-atk-eff').innerText = p.attackEfficiency + "%";
            document.getElementById('stat-def-flat').innerText = p.defenseFlat;
            document.getElementById('stat-def-eff').innerText = p.defenseEfficiency + "%";
            document.getElementById('stat-crit').innerText = p.critRate + "%";
            document.getElementById('stat-eva').innerText = p.evasionRate + "%";
            document.getElementById('stat-leech').innerText = p.leechRate + "%";
            document.getElementById('stat-exp-boost').innerText = p.expBoost + "%";
            document.getElementById('stat-m-pen').innerText = p.mPen + "%";
            document.getElementById('stat-luck').innerText = `${p.luck}%`;
            document.getElementById('stat-accuracy').innerText = `${p.accuracy}%`;
            document.getElementById('stat-hp-regen').innerText = p.hpRegen;
            document.getElementById('stat-mp-regen').innerText = p.mpRegen;
            document.getElementById('stat-crit-dmg').innerText = `${p.critDamage}%`;
            document.getElementById('stat-dmg-boost').innerText = `${p.damageBoost}%`;
            document.getElementById('stat-dmg-reduction').innerText = `${p.damageReduction}%`;
            document.getElementById('stat-rare-find').innerText = `${p.rareFind}%`;
            document.getElementById('stat-gold-boost').innerText = `${p.goldBoost}%`;

            document.getElementById('equip-weapon').innerText = p.weapon?.name || "ãªã—";
            document.getElementById('equip-weapon').className = `font-bold truncate text-sm rarity-${p.weapon?.r||'common'}`;
            document.getElementById('weapon-val').innerText = p.weapon ? `+${p.weapon.val}` : "";
            document.getElementById('equip-armor').innerText = p.armor?.name || "ãªã—";
            document.getElementById('equip-armor').className = `font-bold truncate text-sm rarity-${p.armor?.r||'common'}`;
            document.getElementById('armor-val').innerText = p.armor ? `+${p.armor.val}` : "";

            // Inventory
            const invList = document.getElementById('inventory-list');
            invList.innerHTML = '';
            document.getElementById('inv-count').innerText = p.inventory.length;
            p.inventory.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = "bg-white p-4 rounded-2xl border flex items-center justify-between shadow-sm";
                div.innerHTML = `
                    <div class="min-w-0 flex-1">
                        <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1">${item.type}</div>
                        <div class="font-black text-sm truncate rarity-${item.r}">${item.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold">${item.type==='weapon'?'ATK':'DEF'} +${item.val}</div>
                    </div>
                    <button onclick="equip(${i})" class="ml-4 px-5 py-2.5 bg-slate-800 text-white text-[11px] font-black rounded-xl">è£…å‚™</button>
                `;
                invList.appendChild(div);
            });
        }
    </script>
</body>
</html>
